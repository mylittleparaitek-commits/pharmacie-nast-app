<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Pharmacie Nast ‚Äî Gestion</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Couleurs Pharmacie Nast ‚Äî inspir√©es de mapharmacienast.com */
            --nast-pink: #E91E63;
            --nast-pink-dark: #C2185B;
            --nast-pink-light: #FCE4EC;
            --nast-turquoise: #26C6DA;
            --nast-turquoise-dark: #00ACC1;
            --nast-turquoise-light: #E0F7FA;
            --nast-blue: #2C4A5E;
            --nast-blue-light: #3a5068;
            --nast-glow: rgba(233, 30, 99, 0.08);
            --nast-glow-md: rgba(233, 30, 99, 0.12);
            --nast-glow-strong: rgba(233, 30, 99, 0.18);

            --bg-primary: #ffffff;
            --bg-secondary: #f7f9fb;
            --bg-card: #ffffff;
            --bg-input: #f2f5f8;

            --text-primary: #1a2332;
            --text-secondary: #5a6a7e;
            --text-muted: #9aa8b8;
            --text-on-primary: #ffffff;

            --danger: #e74c3c;
            --danger-bg: #fdf0ef;
            --warning: #f39c12;
            --success: #26C6DA;

            --border: #e8ecf0;
            --border-light: #f0f2f5;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);

            --radius: 14px;
            --radius-sm: 10px;
            --radius-xs: 8px;

            --font-body: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: var(--font-body);
            background: var(--bg-secondary);
            color: var(--text-primary);
            overscroll-behavior: none;
        }

        /* ‚îÄ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ‚îÄ */
        .app {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg-primary);
            position: relative;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        .header {
            padding: 14px 20px 14px;
            background: linear-gradient(135deg, var(--nast-pink) 0%, var(--nast-turquoise) 100%);
            color: white;
            position: relative;
            z-index: 10;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-cross {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-cross svg {
            width: 18px;
            height: 18px;
            color: var(--nast-pink);
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
            opacity: 0.95;
        }

        .header-date {
            font-size: 11px;
            opacity: 0.75;
            font-weight: 400;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ */
        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: calc(90px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
            background: var(--bg-secondary);
        }

        /* ‚îÄ‚îÄ‚îÄ TAB BAR (supprim√©e) ‚îÄ‚îÄ‚îÄ */

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 5px 2px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            letter-spacing: -0.2px;
        }

        .tab-item.active {
            color: var(--nast-pink);
        }

        .tab-item.active .tab-icon-wrap {
            background: var(--nast-pink-light);
        }

        .tab-icon-wrap {
            width: 36px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .tab-icon {
            width: 18px;
            height: 18px;
        }

        /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--nast-pink);
        }

        /* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1.5px solid transparent;
            border-radius: var(--radius-xs);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .input:focus {
            border-color: var(--nast-pink);
            background: white;
            box-shadow: 0 0 0 3px var(--nast-glow-md);
        }

        .input::placeholder { color: var(--text-muted); }

        textarea.input {
            resize: vertical;
            min-height: 100px;
        }

        /* Labo selector */
        .labo-selector { position: relative; }

        .labo-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-xs);
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .labo-suggestions.show { display: block; }

        .labo-suggestion {
            padding: 11px 14px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s;
        }

        .labo-suggestion:last-child { border-bottom: none; }

        .labo-suggestion:hover, .labo-suggestion:active {
            background: var(--nast-pink-light);
        }

        .labo-suggestion mark {
            background: none;
            color: var(--nast-pink);
            font-weight: 600;
        }

        /* Photo zone */
        .photo-zone {
            border: 2px dashed var(--nast-pink);
            border-radius: var(--radius);
            padding: 28px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--nast-glow);
        }

        .photo-zone:active {
            transform: scale(0.98);
            background: var(--nast-glow-strong);
        }

        .photo-zone-icon {
            width: 42px;
            height: 42px;
            margin: 0 auto 10px;
            color: var(--nast-pink);
        }

        .photo-zone-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--nast-pink-dark);
        }

        .photo-zone-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        #photoInput { display: none; }

        /* Photo grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .photo-thumb {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: var(--radius-xs);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-thumb-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--nast-pink);
            color: white;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 500;
            padding: 2px 7px;
            border-radius: 6px;
        }

        .photo-thumb-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .photo-thumb-pdf {
            background: var(--nast-pink-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-icon {
            width: 50%;
            height: 50%;
            color: var(--nast-pink);
        }

        .pdf-icon svg {
            width: 100%;
            height: 100%;
        }

        /* Site selector */
        .site-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
        }

        .site-btn {
            flex: 1;
            padding: 10px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .site-btn.active {
            border-color: var(--nast-pink);
            background: var(--nast-pink-light);
            color: var(--nast-pink-dark);
            font-weight: 600;
        }

        /* Submit button */
        .btn-submit {
            width: 100%;
            padding: 14px;
            background: var(--nast-pink);
            color: white;
            border: none;
            border-radius: var(--radius-xs);
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 166, 81, 0.25);
            margin-top: 6px;
        }

        .btn-submit:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-submit:not(:disabled):active {
            transform: scale(0.98);
            background: var(--nast-pink-dark);
        }

        .btn-submit.loading { color: transparent; }

        .btn-submit.loading::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border: 3px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            top: 50%;
            left: 50%;
            margin: -11px 0 0 -11px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            background: white;
            border: 1px solid var(--nast-pink);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius-xs);
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90vw;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }

        .toast-icon { font-size: 16px; }
        .toast.success .toast-icon { color: var(--nast-pink); }
        .toast.error { border-color: var(--danger); }
        .toast.error .toast-icon { color: var(--danger); }

        /* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
        .stat-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .stat-card-value {
            font-family: var(--font-mono);
            font-size: 32px;
            font-weight: 700;
            color: var(--nast-pink);
            line-height: 1;
        }

        .stat-card-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 500;
        }

        .recent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            box-shadow: var(--shadow-sm);
        }

        .recent-item-icon {
            width: 36px;
            height: 36px;
            background: var(--nast-pink-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--nast-pink);
            flex-shrink: 0;
        }

        .recent-item-info { flex: 1; min-width: 0; }

        .recent-item-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 40px; margin-bottom: 8px; opacity: 0.4; }

        /* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
        .settings-group {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
        }

        .settings-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:last-child { border-bottom: none; }

        .settings-item-label {
            font-size: 14px;
            font-weight: 500;
        }

        .webhook-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .webhook-status.connected {
            background: var(--nast-pink-light);
            color: var(--nast-pink-dark);
        }

        .webhook-status.disconnected {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .webhook-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .settings-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1.5px solid transparent;
            border-radius: var(--radius-xs);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .settings-input:focus {
            border-color: var(--nast-pink);
            background: white;
        }

        .btn-save {
            padding: 10px 20px;
            background: var(--nast-pink);
            color: white;
            border: none;
            border-radius: var(--radius-xs);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn-save:active { background: var(--nast-pink-dark); }

        /* Tab content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ DELPECH ‚Äî case √† cocher facturation ‚îÄ‚îÄ‚îÄ */
        .facturation-toggle {
            display: flex;
            gap: 8px;
        }

        .facturation-btn {
            flex: 1;
            padding: 11px 8px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .facturation-btn.active-paye {
            border-color: #26C6DA;
            background: var(--nast-turquoise-light);
            color: var(--nast-turquoise-dark);
            font-weight: 600;
        }

        .facturation-btn.active-nonfacture {
            border-color: var(--warning);
            background: #fff8e1;
            color: #e65100;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ‚îÄ COMMANDES ‚îÄ‚îÄ‚îÄ */
        .commandes-list { display: flex; flex-direction: column; gap: 10px; }
        .commande-card {
            background: var(--bg-card); border-radius: var(--radius);
            border: 1.5px solid var(--border); padding: 14px 16px;
            cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm);
        }
        .commande-card:active { transform: scale(0.98); }
        .commande-card-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .commande-ref { font-weight: 700; font-size: 15px; color: var(--text-primary); font-family: var(--font-mono); }
        .commande-statut { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; }
        .statut-payplug { background: #e8f5e9; color: #2e7d32; }
        .statut-docmorris { background: #e3f2fd; color: #1565c0; }
        .statut-autre { background: #fff3e0; color: #e65100; }
        .commande-client { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .commande-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 11px; color: var(--text-muted); }

        /* Vue d√©tail */
        .commandes-list-view { display: block; }
        .commandes-list-view.hidden { display: none; }
        .commande-detail-view { display: none; }
        .commande-detail-view.active { display: block; }
        .detail-header {
            background: var(--nast-blue); color: white;
            padding: 14px 16px; border-radius: var(--radius); margin-bottom: 12px;
        }
        .detail-header-top { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .detail-back {
            background: rgba(255,255,255,0.15); border: none; color: white;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px;
        }
        .detail-ref { font-family: var(--font-mono); font-weight: 700; font-size: 16px; }
        .detail-client { font-size: 13px; opacity: 0.85; margin-top: 2px; }
        .detail-date { font-size: 11px; opacity: 0.6; margin-top: 1px; }

        .picking-progress {
            background: var(--bg-card); border-radius: var(--radius);
            padding: 12px 16px; margin-bottom: 12px; border: 1.5px solid var(--border);
        }
        .picking-progress-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .picking-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
        .picking-count { font-size: 13px; font-weight: 700; color: var(--nast-pink); }
        .picking-bar-bg { background: var(--bg-secondary); border-radius: 99px; height: 8px; }
        .picking-bar-fill { background: var(--nast-pink); border-radius: 99px; height: 8px; transition: width 0.4s; }
        .picking-bar-fill.done { background: #26C6DA; }

        .produits-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .produit-item {
            background: var(--bg-card); border-radius: var(--radius-sm);
            border: 1.5px solid var(--border); padding: 12px 14px;
            display: flex; align-items: center; gap: 12px; transition: all 0.2s;
        }
        .produit-item.scanned { border-color: #26C6DA; background: #f0fdfe; }
        .produit-check {
            width: 26px; height: 26px; border-radius: 50%; border: 2px solid var(--border);
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        .produit-item.scanned .produit-check { background: #26C6DA; border-color: #26C6DA; color: white; }
        .produit-info { flex: 1; min-width: 0; }
        .produit-nom { font-size: 13px; font-weight: 500; color: var(--text-primary); line-height: 1.3; }
        .produit-ean { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); margin-top: 2px; }
        .produit-qty {
            font-size: 13px; font-weight: 700; color: var(--nast-blue);
            background: var(--bg-secondary); padding: 4px 10px; border-radius: var(--radius-xs); flex-shrink: 0;
        }
        .produit-origine { font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 10px; flex-shrink: 0; }
        .origine-nast { background: #fce4ec; color: var(--nast-pink-dark); }
        .origine-mf { background: #e3f2fd; color: #1565c0; }

        .btn-scan {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 16px; background: var(--nast-pink); color: white;
            border: none; border-radius: var(--radius); font-size: 15px; font-weight: 600;
            cursor: pointer; font-family: var(--font-body);
            box-shadow: 0 4px 16px rgba(233,30,99,0.3); transition: all 0.2s; margin-bottom: 12px;
        }
        .btn-scan:active { transform: scale(0.98); }
        .btn-scan.scanning { background: var(--nast-blue); }

        /* Overlay scanner */
        .scanner-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.95); z-index: 1000;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .scanner-overlay.active { display: flex; }
        .scanner-video-wrap { position: relative; display: flex; align-items: center; justify-content: center; }
        .scanner-video { width: 90vw; max-width: 400px; border-radius: var(--radius); }
        .scanner-frame {
            position: absolute; width: 260px; height: 120px;
            border: 3px solid var(--nast-pink); border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
        }
        .scanner-line {
            position: absolute; width: 220px; height: 2px;
            background: var(--nast-pink); opacity: 0.9;
            animation: scanline 2s ease-in-out infinite;
        }
        @keyframes scanline { 0%,100% { transform: translateY(-45px); } 50% { transform: translateY(45px); } }
        .scanner-label { color: white; margin-top: 20px; font-size: 14px; opacity: 0.8; text-align: center; padding: 0 20px; }
        .scanner-close {
            position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.6);
            color: white; padding: 14px 40px; border-radius: 30px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            font-family: var(--font-body); letter-spacing: 0.3px; white-space: nowrap;
        }
        .scanner-result { color: white; margin-top: 12px; font-family: var(--font-mono); font-size: 13px; min-height: 20px; }
        .scanner-feedback {
            position: absolute; inset: 0; border-radius: var(--radius);
            pointer-events: none; opacity: 0; transition: opacity 0.15s;
        }
        .scanner-feedback.ok { background: rgba(38,198,218,0.3); opacity: 1; }
        .scanner-feedback.ko { background: rgba(233,30,99,0.3); opacity: 1; }

        /* ‚îÄ‚îÄ‚îÄ SAV ‚îÄ‚îÄ‚îÄ */
        .sav-ticket {
            background: var(--bg-card); border-radius: var(--radius);
            border: 1.5px solid var(--border); padding: 14px 16px;
            cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm);
            margin-bottom: 10px;
        }
        .sav-ticket:active { transform: scale(0.98); }
        .sav-ticket-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .sav-ticket-sujet { font-weight: 600; font-size: 14px; color: var(--text-primary); flex:1; margin-right:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .sav-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 20px; flex-shrink:0; text-transform:uppercase; }
        .sav-badge-nouveau { background:#fce4ec; color:#c2185b; }
        .sav-badge-en_cours { background:#fff3e0; color:#e65100; }
        .sav-badge-r√©solu { background:#e8f5e9; color:#2e7d32; }
        .sav-ticket-from { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .sav-ticket-preview { font-size: 12px; color: var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .sav-ticket-date { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

        /* Vue d√©tail SAV */
        .sav-list-view { display: block; }
        .sav-list-view.hidden { display: none; }
        .sav-detail-view { display: none; }
        .sav-detail-view.active { display: flex; flex-direction: column; height: 100%; }

        .sav-fil { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
        .sav-msg {
            max-width: 85%; padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.5;
        }
        .sav-msg-client { background: var(--bg-secondary); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 4px; }
        .sav-msg-nous { background: var(--nast-pink); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .sav-msg-meta { font-size: 10px; opacity: 0.65; margin-top: 4px; }

        .sav-reply-box { background: var(--bg-card); border-top: 1px solid var(--border); padding: 12px 16px; position: sticky; bottom: 0; }
        .sav-reply-area {
            width: 100%; min-height: 80px; padding: 10px 12px;
            border: 1.5px solid var(--border); border-radius: var(--radius-sm);
            font-family: var(--font-body); font-size: 13px; color: var(--text-primary);
            background: var(--bg-input); resize: none; margin-bottom: 8px;
        }
        .sav-reply-area:focus { outline: none; border-color: var(--nast-pink); }
        .sav-btns { display: flex; gap: 8px; }
        .btn-ia {
            flex:1; padding: 12px; background: var(--nast-blue); color: white;
            border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600;
            cursor: pointer; font-family: var(--font-body); display:flex; align-items:center; justify-content:center; gap:6px;
        }
        .btn-send {
            flex:1; padding: 12px; background: var(--nast-pink); color: white;
            border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600;
            cursor: pointer; font-family: var(--font-body);
        }
        .btn-resolu {
            width:100%; padding: 10px; background: #e8f5e9; color: #2e7d32;
            border: none; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600;
            cursor: pointer; font-family: var(--font-body); margin-bottom: 8px;
        }
        .ia-loading { text-align:center; padding:8px; font-size:12px; color:var(--text-muted); }

        .sav-filter {
            padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--border);
            background: white; font-size: 11px; font-weight: 600; cursor: pointer;
            font-family: var(--font-body); color: var(--text-secondary); transition: all 0.2s;
        }
        .sav-filter.active { background: var(--nast-pink); color: white; border-color: var(--nast-pink); }

        /* ‚îÄ‚îÄ‚îÄ TODO ‚îÄ‚îÄ‚îÄ */
        .todo-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
        .todo-filters { display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap; }
        .todo-filter { padding:6px 12px; border-radius:20px; border:1.5px solid var(--border); background:white; font-size:11px; font-weight:700; cursor:pointer; font-family:var(--font-body); color:var(--text-secondary); transition:all 0.2s; text-transform:uppercase; }
        .todo-filter.active { background:var(--nast-pink); color:white; border-color:var(--nast-pink); }

        .todo-card {
            background:var(--bg-card); border-radius:var(--radius); border:1.5px solid var(--border);
            padding:14px 16px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px;
            box-shadow:var(--shadow-sm); transition:all 0.2s;
        }
        .todo-card.done { opacity:0.5; background:#f9fafb; border-color:#eee; }
        .todo-check {
            width:32px; height:32px; min-width:32px; border-radius:50%; border:2px solid var(--border);
            flex-shrink:0; cursor:pointer; display:flex; align-items:center; justify-content:center;
            font-size:14px; transition:all 0.2s; margin-top:0px; -webkit-tap-highlight-color: rgba(233,30,99,0.15);
        }
        .todo-check.checked { background:var(--nast-pink); border-color:var(--nast-pink); color:white; }
        .todo-body { flex:1; min-width:0; }
        .todo-titre { font-size:14px; font-weight:600; color:var(--text-primary); margin-bottom:4px; }
        .todo-card.done .todo-titre { text-decoration:line-through; color:var(--text-muted); }
        .todo-card.done .todo-notes { text-decoration:line-through; opacity:0.6; }
        .todo-notes { font-size:12px; color:var(--text-secondary); margin-bottom:6px; }
        .todo-meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .todo-prio { font-size:10px; font-weight:700; padding:2px 8px; border-radius:12px; text-transform:uppercase; }
        .todo-prio-urgent { background:#fce4ec; color:#c2185b; }
        .todo-prio-normal { background:#e3f2fd; color:#1565c0; }
        .todo-prio-faible { background:#f3e5f5; color:#6a1b9a; }
        .todo-date { font-size:10px; color:var(--text-muted); }

        /* Formulaire ajout t√¢che */
        .todo-add-btn {
            width:100%; padding:14px; background:var(--nast-pink); color:white;
            border:none; border-radius:var(--radius); font-size:14px; font-weight:700;
            cursor:pointer; font-family:var(--font-body); display:flex; align-items:center;
            justify-content:center; gap:8px; margin-bottom:16px;
        }
        .todo-form {
            background:var(--bg-card); border-radius:var(--radius); border:1.5px solid var(--border);
            padding:16px; margin-bottom:16px; display:none;
        }
        .todo-form.visible { display:block; }
        .todo-form input, .todo-form textarea, .todo-form select {
            width:100%; padding:10px 12px; border:1.5px solid var(--border);
            border-radius:var(--radius-sm); font-family:var(--font-body); font-size:13px;
            color:var(--text-primary); background:var(--bg-input); margin-bottom:10px;
        }
        .todo-form input:focus, .todo-form textarea:focus, .todo-form select:focus {
            outline:none; border-color:var(--nast-pink);
        }
        .todo-form-btns { display:flex; gap:8px; }
        .btn-todo-save { flex:1; padding:12px; background:var(--nast-pink); color:white; border:none; border-radius:var(--radius-sm); font-size:13px; font-weight:700; cursor:pointer; font-family:var(--font-body); }
        .btn-todo-cancel { flex:1; padding:12px; background:#f2f5f8; color:var(--text-secondary); border:none; border-radius:var(--radius-sm); font-size:13px; font-weight:600; cursor:pointer; font-family:var(--font-body); }

        /* ‚îÄ‚îÄ‚îÄ Sous-onglets A traiter / TODO ‚îÄ‚îÄ‚îÄ */
        .subtab-bar {
            display: flex;
            background: #f2f5f8;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
            gap: 4px;
        }
        .subtab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 9px;
            background: transparent;
            font-family: var(--font-body);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .subtab-btn.active {
            background: white;
            color: var(--nast-pink);
            box-shadow: 0 1px 4px rgba(0,0,0,0.12);
        }
        .subtab-panel { display: none; }
        .subtab-panel.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ MENU PRINCIPAL ‚îÄ‚îÄ‚îÄ */
        .menu-home { display: block; }
        .menu-home.hidden { display: none; }
        .section-view { display: none; }
        .section-view.active { display: block; }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            padding: 4px 0;
        }

        .menu-card {
            background: white;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .menu-card:active { transform: scale(0.97); }

        .menu-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
        }

        .menu-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .menu-card-sub {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .menu-card-pharma .menu-card-icon { background: #fce4ec; }
        .menu-card-pharma { border-bottom: 3px solid var(--nast-pink); }
        .menu-card-nast .menu-card-icon { background: #e3f2fd; }
        .menu-card-nast { border-bottom: 3px solid #1976D2; }
        .menu-card-mlp .menu-card-icon { background: #f3e5f5; }
        .menu-card-mlp { border-bottom: 3px solid #9C27B0; }
        .menu-card-settings .menu-card-icon { background: #f5f5f5; }
        .menu-card-settings { border-bottom: 3px solid #78909C; }

        /* ‚îÄ‚îÄ‚îÄ SECTION HEADER (retour + titre + sub-tabs) ‚îÄ‚îÄ‚îÄ */
        .section-back {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .btn-back {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1.5px solid var(--border);
            background: white;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            transition: all 0.15s;
        }

        .btn-back:active { transform: scale(0.9); background: var(--bg-secondary); }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Sub-tabs scrollable pour les sections */
        .section-subtabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 2px;
        }
        .section-subtabs::-webkit-scrollbar { display: none; }

        .section-subtab {
            padding: 9px 14px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: white;
            font-family: var(--font-body);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .section-subtab.active {
            background: var(--nast-pink);
            color: white;
            border-color: var(--nast-pink);
        }

        .section-subtab.active-blue {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .section-subtab.active-purple {
            background: #9C27B0;
            color: white;
            border-color: #9C27B0;
        }

        .section-panel { display: none; }
        .section-panel.active { display: block; }

        /* Menu greeting */
        .menu-greeting {
            margin-bottom: 20px;
        }
        .menu-greeting-hello {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .menu-greeting-sub {
            font-size: 13px;
            color: var(--text-muted);
        }
    
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-cross">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                    </div>
                    <span class="logo-text">Pharmacie Nast</span>
                </div>
                <span class="header-date" id="headerDate"></span>
            </div>
            <h1 id="headerTitle">Accueil</h1>
        </header>

        <!-- Content -->
        <main class="content">

            <!-- ‚ïê‚ïê‚ïê MENU PRINCIPAL ‚ïê‚ïê‚ïê -->
            <div class="menu-home" id="menuHome">
                <div class="menu-greeting">
                    <div class="menu-greeting-hello">üëã Bonjour !</div>
                    <div class="menu-greeting-sub" id="menuDate"></div>
                </div>
                <div class="menu-grid">
                    <div class="menu-card menu-card-pharma" onclick="openSection('pharma')">
                        <div class="menu-card-icon">üè•</div>
                        <div class="menu-card-title">Pharmacie</div>
                        <div class="menu-card-sub">Officine ¬∑ Quotidien</div>
                    </div>
                    <div class="menu-card menu-card-nast" onclick="openSection('nastcom')">
                        <div class="menu-card-icon">üõí</div>
                        <div class="menu-card-title">Nast.com</div>
                        <div class="menu-card-sub">Commandes ¬∑ Site web</div>
                    </div>
                    <div class="menu-card menu-card-mlp" onclick="openSection('mlp')">
                        <div class="menu-card-icon">üíú</div>
                        <div class="menu-card-title">My Little Para</div>
                        <div class="menu-card-sub">MLP ¬∑ E-commerce</div>
                    </div>
                    <div class="menu-card menu-card-settings" onclick="openSection('settings')">
                        <div class="menu-card-icon">‚öôÔ∏è</div>
                        <div class="menu-card-title">R√©glages</div>
                        <div class="menu-card-sub">Webhooks ¬∑ Compte</div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê SECTION PHARMACIE NAST ‚ïê‚ïê‚ïê -->
            <div class="section-view" id="sectionPharma">
                <div class="section-back">
                    <button class="btn-back" onclick="goHome()">‚Üê</button>
                    <div class="section-title">üè• Pharmacie Nast</div>
                </div>
                <div class="section-subtabs" id="pharmaSubtabs">
                    <button class="section-subtab active" onclick="switchSection('pharma','reception',this)">üì¶ R√©ception</button>
                    <button class="section-subtab" onclick="switchSection('pharma','delpech',this)">üíä Delpech</button>
                    <button class="section-subtab" onclick="switchSection('pharma','todoPharma',this)">‚úÖ Messages</button>
                    <button class="section-subtab" onclick="switchSection('pharma','dashboard',this)">üìä Dashboard</button>
                </div>

                <div class="section-panel active" id="pharma_reception">

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Informations livraison</div>

                    <div class="form-group">
                        <label class="form-label">Laboratoire</label>
                        <div class="labo-selector">
                            <input type="text" class="input" id="laboInput" placeholder="Rechercher ou saisir un labo..." autocomplete="off">
                            <div class="labo-suggestions" id="laboSuggestions"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">R√©ceptionn√© par</label>
                        <input type="text" class="input" id="receptInput" placeholder="Nom du r√©ceptionnaire">
                    </div>


                </div>

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Photos du bon de livraison</div>
                    <div class="photo-zone" id="photoZone">
                        <svg class="photo-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <div class="photo-zone-text">Ajouter le bon de livraison</div>
                        <div class="photo-zone-sub">Photo, PDF ou image ¬∑ Plusieurs fichiers possibles</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*,application/pdf" multiple>
                    <div class="photos-grid" id="photosGrid"></div>
                </div>

                <button class="btn-submit" id="btnSubmit" disabled>
                    ‚úì Envoyer sur Google Drive
                </button>
            
                </div>

                <div class="section-panel" id="pharma_delpech">

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Pr√©paration magistrale</div>

                    <div class="form-group">
                        <label class="form-label">Laboratoire</label>
                        <input type="text" class="input" id="delpechLaboInput" value="DELPECH PREPARATOIRE" readonly style="color:var(--text-muted);background:var(--bg-input);">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Envoy√© par</label>
                        <input type="text" class="input" id="delpechEnvoyeurInput" placeholder="Nom de l'exp√©diteur">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nom du client</label>
                        <input type="text" class="input" id="delpechClientInput" placeholder="Nom / Pr√©nom du patient">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Principe actif de la pr√©paration</label>
                        <input type="text" class="input" id="delpechPrincipeInput" placeholder="ex: K√©toprof√®ne 2,5%">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Num√©ro du promis</label>
                        <input type="text" class="input" id="delpechPromisInput" placeholder="N¬∞ promis">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Statut facturation</label>
                        <div class="facturation-toggle">
                            <button class="facturation-btn active-paye" id="btnPaye" onclick="selectFacturation('paye')">‚úì Pay√© / Factur√©</button>
                            <button class="facturation-btn" id="btnNonFacture" onclick="selectFacturation('nonfacture')">‚ö† Non factur√©</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Photo / document de la pr√©paration</div>
                    <div class="photo-zone" id="delpechPhotoZone">
                        <svg class="photo-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <div class="photo-zone-text">Ajouter la pr√©paration</div>
                        <div class="photo-zone-sub">Photo ou PDF ¬∑ Plusieurs fichiers possibles</div>
                    </div>
                    <input type="file" id="delpechPhotoInput" accept="image/*,application/pdf" multiple>
                    <div class="photos-grid" id="delpechPhotosGrid"></div>
                </div>

                <button class="btn-submit" id="btnDelpechSubmit" disabled>
                    ‚úâ Envoyer par mail + Drive
                </button>
            
                </div>

                <div class="section-panel" id="pharma_todoPharma">
                    <div class="commande-empty"><div class="commande-empty-icon">üí¨</div><p>Messages √©quipe ‚Äî Bient√¥t disponible</p></div>
                </div>

                <div class="section-panel" id="pharma_dashboard">


                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <div class="card-title" style="margin-bottom:0;"><span class="card-title-dot"></span>Aujourd'hui</div>
                    <button onclick="loadSheetData()" style="background:none;border:none;cursor:pointer;color:var(--nast-pink);font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px;">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Actualiser
                    </button>
                </div>

                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="statToday">‚Äî</div>
                        <div class="stat-card-label">R√©ceptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="statLabos">‚Äî</div>
                        <div class="stat-card-label">Labos diff√©rents</div>
                    </div>
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <div class="card-title" style="margin-bottom:0;"><span class="card-title-dot"></span>Derni√®res r√©ceptions</div>
                    <span id="dashLastUpdate" style="font-size:10px;color:var(--text-muted);"></span>
                </div>

                <div id="dashStatus" style="display:none; text-align:center; padding:16px; font-size:13px; color:var(--text-muted);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px;"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                    Chargement‚Ä¶
                </div>

                <div class="recent-list" id="recentList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>Appuyez sur Actualiser</p>
                    </div>
                </div>
            
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê SECTION NAST.COM ‚ïê‚ïê‚ïê -->
            <div class="section-view" id="sectionNastcom">
                <div class="section-back">
                    <button class="btn-back" onclick="goHome()">‚Üê</button>
                    <div class="section-title">üõí Nast.com</div>
                </div>
                <div class="section-subtabs" id="nastcomSubtabs">
                    <button class="section-subtab active-blue" onclick="switchSection('nastcom','traiter',this,'blue')">üì¶ √Ä traiter</button>
                    <button class="section-subtab" onclick="switchSection('nastcom','todoNast',this,'blue')">‚úÖ Todo</button>
                </div>

                <div class="section-panel active" id="nastcom_traiter">
<!-- Sous-onglets NAST -->
                

                <!-- Panel √Ä traiter -->
                
                <!-- Vue liste -->
                <div class="commandes-list-view" id="commandesListView">
                    <div class="commandes-header">
                        <div class="card-title" style="margin-bottom:0;"><span class="card-title-dot"></span>√Ä traiter</div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <span class="commandes-count" id="commandesCount"></span>
                            <button onclick="loadCommandes()" style="background:none;border:none;cursor:pointer;color:var(--nast-pink);font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px;">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                Actualiser
                            </button>
                        </div>
                    </div>
                    <div id="commandesStatus" style="display:none;text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px;"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        Chargement‚Ä¶
                    </div>
                    <div class="commandes-list" id="commandesList">
                        <div class="commande-empty">
                            <div class="commande-empty-icon">üõí</div>
                            <p>Appuyez sur Actualiser</p>
                        </div>
                    </div>
                </div>
                </div>

                <div class="section-panel" id="nastcom_todoNast">

                    <button class="todo-add-btn" onclick="toggleTodoForm('nast')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nouvelle t√¢che
                    </button>
                    <div class="todo-form" id="todoFormNast">
                        <input type="text" id="todoNastTitre" placeholder="Titre de la t√¢che *">
                        <textarea id="todoNastNotes" placeholder="Notes / description (optionnel)" rows="2" style="resize:none;"></textarea>
                        <select id="todoNastPrio">
                            <option value="normal">üîµ Normal</option>
                            <option value="urgent">üî¥ Urgent</option>
                            <option value="faible">üü£ Faible</option>
                        </select>
                        <div class="todo-form-btns">
                            <button class="btn-todo-save" onclick="saveTodoNast()">Ajouter</button>
                            <button class="btn-todo-cancel" onclick="toggleTodoForm('nast')">Annuler</button>
                        </div>
                    </div>
                    <div class="todo-filters">
                        <button class="todo-filter active" onclick="filterTodo('nast','tous',this)">Tous</button>
                        <button class="todo-filter" onclick="filterTodo('nast','urgent',this)">üî¥ Urgent</button>
                        <button class="todo-filter" onclick="filterTodo('nast','normal',this)">üîµ Normal</button>
                        <button class="todo-filter" onclick="filterTodo('nast','done',this)">‚úÖ R√©solus</button>
                    </div>
                    <div id="todoNastStatus" style="display:none;text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">Chargement‚Ä¶</div>
                    <div id="todoNastList"></div>
                </div><!-- /nastcom_todoNast -->
            </div><!-- /sectionNastcom -->

            <!-- ‚ïê‚ïê‚ïê SECTION MLP ‚ïê‚ïê‚ïê -->
            <div class="section-view" id="sectionMlp">
                <div class="section-back">
                    <button class="btn-back" onclick="goHome()">‚Üê</button>
                    <div class="section-title">üíú My Little Para</div>
                </div>
                <div class="section-subtabs" id="mlpSubtabs">
                    <button class="section-subtab active-purple" onclick="switchSection('mlp','traiterMlp',this,'purple')">üì¶ √Ä traiter</button>
                    <button class="section-subtab" onclick="switchSection('mlp','savMlp',this,'purple')">üí¨ SAV</button>
                    <button class="section-subtab" onclick="switchSection('mlp','todoWeb',this,'purple')">‚úÖ Todo</button>
                </div>

                <div class="section-panel active" id="mlp_traiterMlp">
<!-- Vue liste -->
                <div class="commandes-list-view" id="mlpListView">
                    <div class="commandes-header">
                        <div class="card-title" style="margin-bottom:0;"><span class="card-title-dot"></span>MLP ‚Äî √Ä traiter</div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <span class="commandes-count" id="mlpCount"></span>
                            <button onclick="loadMLP()" style="background:none;border:none;cursor:pointer;color:var(--nast-pink);font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px;">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                Actualiser
                            </button>
                        </div>
                    </div>
                    <div id="mlpStatus" style="display:none;text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px;"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        Chargement‚Ä¶
                    </div>
                    <div class="commandes-list" id="mlpList">
                        <div class="commande-empty">
                            <div class="commande-empty-icon">üíä</div>
                            <p>Appuyez sur Actualiser</p>
                        </div>
                    </div>
                </div>

                <!-- Vue d√©tail commande MLP -->
                <div class="commande-detail-view" id="mlpDetailView">
                    <div class="detail-header">
                        <div class="detail-header-top">
                            <button class="detail-back" onclick="closeMlpDetail()">‚Üê</button>
                            <div><div class="detail-ref" id="mlpDetailRef"></div></div>
                        </div>
                        <div class="detail-client" id="mlpDetailClient"></div>
                        <div class="detail-date" id="mlpDetailDate"></div>
                    </div>

                    <div class="picking-progress">
                        <div class="picking-progress-top">
                            <span class="picking-label">Picking en cours</span>
                            <span class="picking-count" id="mlpPickingCount">0 / 0</span>
                        </div>
                        <div class="picking-bar-bg">
                            <div class="picking-bar-fill" id="mlpPickingBar" style="width:0%"></div>
                        </div>
                    </div>

                    <div class="produits-list" id="mlpProduitsList"></div>

                    <input type="file" accept="image/*" capture="environment" id="mlpScannerInput" style="display:none" onchange="handleMlpScannerInput(event)">

                    <button class="btn-scan" onclick="startMlpScan()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h10M7 12h10M7 17h10"/></svg>
                        Scanner un produit
                    </button>
                </div>
                </div>

                <div class="section-panel" id="mlp_savMlp">
<!-- Vue liste tickets -->
                <div class="sav-list-view" id="savListView">
                    <div class="commandes-header">
                        <div class="card-title" style="margin-bottom:0;"><span class="card-title-dot"></span>SAV My Little Para</div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <span class="commandes-count" id="savCount"></span>
                            <button onclick="loadSAV()" style="background:none;border:none;cursor:pointer;color:var(--nast-pink);font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px;">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                Actualiser
                            </button>
                        </div>
                    </div>

                    <!-- Filtres statut -->
                    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
                        <button class="sav-filter active" data-filter="tous" onclick="filterSAV('tous',this)">Tous</button>
                        <button class="sav-filter" data-filter="nouveau" onclick="filterSAV('nouveau',this)">üî¥ Nouveaux</button>
                        <button class="sav-filter" data-filter="en_cours" onclick="filterSAV('en_cours',this)">üü† En cours</button>
                        <button class="sav-filter" data-filter="r√©solu" onclick="filterSAV('r√©solu',this)">‚úÖ R√©solus</button>
                    </div>

                    <div id="savStatus" style="display:none;text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px;"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        Chargement‚Ä¶
                    </div>
                    <div id="savList"></div>
                </div>

                <!-- Vue d√©tail ticket -->
                <div class="sav-detail-view" id="savDetailView">
                    <div class="detail-header" style="margin-bottom:12px;">
                        <div class="detail-header-top">
                            <button class="detail-back" onclick="closeSavDetail()">‚Üê</button>
                            <div style="flex:1;min-width:0;">
                                <div class="detail-ref" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="savDetailSujet"></div>
                            </div>
                        </div>
                        <div class="detail-client" id="savDetailFrom"></div>
                        <div class="detail-date" id="savDetailDate"></div>
                    </div>

                    <div class="sav-fil" id="savFil"></div>

                    <div class="sav-reply-box">
                        <button class="btn-resolu" id="savBtnResolu" onclick="marquerResolu()">‚úÖ Marquer comme r√©solu</button>
                        <textarea class="sav-reply-area" id="savReplyArea" placeholder="Votre r√©ponse‚Ä¶"></textarea>
                        <div class="sav-btns">
                            <button class="btn-ia" onclick="suggererReponseIA()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
                                R√©ponse IA
                            </button>
                            <button class="btn-send" onclick="envoyerReponse()">Envoyer ‚Üí</button>
                        </div>
                        <div class="ia-loading" id="iaLoading" style="display:none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;vertical-align:middle;margin-right:4px;"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                            Claude r√©dige une r√©ponse‚Ä¶
                        </div>
                    </div>
                </div>
            </div>
                </div>

                <div class="section-panel" id="mlp_todoWeb">
<button class="todo-add-btn" onclick="toggleTodoForm('web')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nouvelle t√¢che
                    </button>
                    <div class="todo-form" id="todoFormWeb">
                        <input type="text" id="todoWebTitre" placeholder="Titre de la t√¢che *">
                        <textarea id="todoWebNotes" placeholder="Notes (optionnel)" rows="2" style="resize:none;"></textarea>
                        <select id="todoWebPrio">
                            <option value="normal">üîµ Normal</option>
                            <option value="urgent">üî¥ Urgent</option>
                            <option value="faible">üü£ Faible</option>
                        </select>
                        <div class="todo-form-btns">
                            <button class="btn-todo-save" onclick="saveTodoWeb()">Ajouter</button>
                            <button class="btn-todo-cancel" onclick="toggleTodoForm('web')">Annuler</button>
                        </div>
                    </div>
                    <div class="todo-filters">
                        <button class="todo-filter active" onclick="filterTodo('web','tous',this)">Tous</button>
                        <button class="todo-filter" onclick="filterTodo('web','urgent',this)">üî¥ Urgent</button>
                        <button class="todo-filter" onclick="filterTodo('web','normal',this)">üîµ Normal</button>
                        <button class="todo-filter" onclick="filterTodo('web','done',this)">‚úÖ R√©solus</button>
                    </div>
                    <div id="todoWebStatus" style="display:none;text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">Chargement‚Ä¶</div>
                    <div id="todoWebList"></div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê SECTION R√âGLAGES ‚ïê‚ïê‚ïê -->
            <div class="section-view" id="sectionSettings">
                <div class="section-back">
                    <button class="btn-back" onclick="goHome()">‚Üê</button>
                    <div class="section-title">‚öôÔ∏è R√©glages</div>
                </div>
<div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>Webhooks n8n</div>
                <div class="settings-group">
                    <div class="settings-item">
                        <span class="settings-item-label">Statut BL</span>
                        <span class="webhook-status disconnected" id="webhookStatus">
                            <span class="webhook-dot"></span>
                            Non configur√©
                        </span>
                    </div>
                    <div style="padding: 14px 16px;">
                        <label class="form-label">URL webhook ‚Äî R√©ception BL</label>
                        <input type="url" class="settings-input" id="webhookUrlInput" placeholder="https://n8n.example.com/webhook/reception-bl">
                        <button class="btn-save" id="btnSaveSettings">Sauvegarder</button>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-item">
                        <span class="settings-item-label">Statut Delpech</span>
                        <span class="webhook-status disconnected" id="webhookDelpechStatus">
                            <span class="webhook-dot"></span>
                            Non configur√©
                        </span>
                    </div>
                    <div style="padding: 14px 16px;">
                        <label class="form-label">URL webhook ‚Äî Delpech Pr√©paratoire</label>
                        <input type="url" class="settings-input" id="webhookDelpechInput" placeholder="https://n8n.example.com/webhook/delpech">
                        <button class="btn-save" id="btnSaveDelpechWebhook">Sauvegarder</button>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-item">
                        <span class="settings-item-label">Statut SAV MLP</span>
                        <span class="webhook-status disconnected" id="webhookSavStatus">
                            <span class="webhook-dot"></span>
                            Non configur√©
                        </span>
                    </div>
                    <div style="padding: 14px 16px;">
                        <label class="form-label">URL webhook ‚Äî R√©ponse SAV MLP</label>
                        <input type="url" class="settings-input" id="webhookSavInput" placeholder="https://n8n.example.com/webhook/sav-reply-mlp">
                        <button class="btn-save" id="btnSaveSavWebhook">Sauvegarder</button>
                    </div>
                </div>

                <div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>Liste des laboratoires</div>
                <div class="settings-group">
                    <div style="padding: 14px 16px;">
                        <label class="form-label">Un labo par ligne</label>
                        <textarea class="input" id="labosListInput" style="min-height:180px;font-size:13px;" placeholder="BIOGARAN&#10;SANDOZ&#10;MYLAN&#10;..."></textarea>
                        <button class="btn-save" id="btnSaveLabos">Sauvegarder les labos</button>
                    </div>
                </div>
            </div>
            </div>

            <!-- SCANNER OVERLAY -->
            <div class="scanner-overlay" id="scannerOverlay">
                <button class="scanner-close" onclick="stopScan()">‚úï Fermer</button>
                <div class="scanner-result" id="scannerResult"></div>
            </div>


        </main>

        <!-- Tab bar supprim√©e ‚Äî remplac√©e par menu principal -->

        <!-- Toast -->
        <div class="toast" id="toast">
            <span class="toast-icon">‚úì</span>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
        const state = { photos: [], recentReceptions: [], labos: [], site: 'NAST' };
        const delpechState = { photos: [], facturation: 'paye' };

        const DEFAULT_LABOS = [
            'ABBOTT', 'ACCU-CHECK', 'ARROW', 'BAUSCH & LOMB', 'BAYER', 'BIOGARAN',
            'BIODERMA', 'BOIRON', 'BRAUN', 'COOPER', 'EAFIT', 'EG LABO', 'ELANCO',
            'FORT√â PHARMA', 'GALLIA', 'GSK', 'JOHNSON & JOHNSON', 'LA ROCHE-POSAY',
            'LEO PHARMA', 'LES SECRETS DE LOLY', 'LUX√âOL', 'MERCK', 'MY VARIATIONS',
            'MYLAN', 'NOVARTIS', 'NUTRI&CO', 'NUXE', 'OENOBIOL', 'ONE TOUCH',
            'PFIZER', 'PIERRE FABRE', 'PURESSENTIEL', 'ROC', 'ROCHE', 'SANOFI',
            'SANDOZ', 'SERVIER', 'SUPERDIET', 'SVR', 'TENA', 'TEVA', 'TH√âRALICA',
            'TOPICREM', 'URIAGE', 'URGO', 'VIATRIS', 'VICHY'
        ];

        
        // ‚îÄ‚îÄ‚îÄ NAVIGATION MENU PRINCIPAL ‚îÄ‚îÄ‚îÄ
        let currentSection = null;

        function openSection(section) {
            document.getElementById('menuHome').classList.add('hidden');
            document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
            
            const sectionMap = {
                'pharma': 'sectionPharma',
                'nastcom': 'sectionNastcom',
                'mlp': 'sectionMlp',
                'settings': 'sectionSettings'
            };
            
            const titles = {
                'pharma': 'üè• Pharmacie Nast',
                'nastcom': 'üõí Nast.com',
                'mlp': 'üíú My Little Para',
                'settings': '‚öôÔ∏è R√©glages'
            };
            
            const el = document.getElementById(sectionMap[section]);
            if (el) el.classList.add('active');
            document.getElementById('headerTitle').textContent = titles[section] || '';
            currentSection = section;
            
            // Auto-load data
            if (section === 'nastcom') loadCommandes();
            if (section === 'mlp') loadMLP();
            if (section === 'pharma') {
                // Check quel panel est actif
                const activePanel = document.querySelector('#sectionPharma .section-panel.active');
                if (activePanel?.id === 'pharma_dashboard') loadSheetData();
            }
        }

        function goHome() {
            document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
            document.getElementById('menuHome').classList.remove('hidden');
            document.getElementById('headerTitle').textContent = 'Accueil';
            currentSection = null;
        }

        function switchSection(section, panel, btn, color) {
            const container = btn.closest('.section-view');
            
            // Reset tous les subtabs
            container.querySelectorAll('.section-subtab').forEach(b => {
                b.classList.remove('active', 'active-blue', 'active-purple');
            });
            
            // Activer le bon
            const activeClass = color ? ('active-' + color) : 'active';
            btn.classList.add(activeClass);
            
            // Changer panels
            container.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
            const panelEl = document.getElementById(section + '_' + panel);
            if (panelEl) panelEl.classList.add('active');
            
            // Auto-load
            if (panel === 'todoNast') loadTodoNast();
            if (panel === 'todoWeb') loadTodoWeb();
            if (panel === 'savMlp') loadSAV();
            if (panel === 'dashboard') loadSheetData();
            if (panel === 'traiter') loadCommandes();
            if (panel === 'traiterMlp') loadMLP();
        }

        // Menu date
        function updateMenuDate() {
            const el = document.getElementById('menuDate');
            if (el) {
                const now = new Date();
                el.textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }
        }

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
        function init() {
            updateDate();
            updateMenuDate();
            loadSettings();
            loadLabos();
            loadHistory();
            setupTabs();
            setupLaboInput();
            setupPhotoCapture();
            setupFormValidation();
            setupSettings();
            setupDelpech();
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('headerDate').textContent = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        // ‚îÄ‚îÄ‚îÄ TABS (remplac√© par menu sections) ‚îÄ‚îÄ‚îÄ
        function setupTabs() {
            // Plus de tab bar ‚Äî navigation par menu principal + sections
        }

        // ‚îÄ‚îÄ‚îÄ SITE SELECTOR ‚îÄ‚îÄ‚îÄ
        function selectSite(btn) {
            document.querySelectorAll('.site-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.site = btn.dataset.site;
        }

        // ‚îÄ‚îÄ‚îÄ LABO ‚îÄ‚îÄ‚îÄ
        function setupLaboInput() {
            const input = document.getElementById('laboInput');
            const suggestions = document.getElementById('laboSuggestions');

            input.addEventListener('input', () => {
                const val = input.value.trim().toUpperCase();
                if (!val) { suggestions.classList.remove('show'); validateForm(); return; }
                const matches = state.labos.filter(l => l.toUpperCase().includes(val));
                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(m => {
                        const hl = m.replace(new RegExp(`(${val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<mark>$1</mark>');
                        return `<div class="labo-suggestion">${hl}</div>`;
                    }).join('');
                    suggestions.classList.add('show');
                    suggestions.querySelectorAll('.labo-suggestion').forEach(s => {
                        s.addEventListener('click', () => {
                            input.value = s.textContent;
                            suggestions.classList.remove('show');
                            validateForm();
                        });
                    });
                } else {
                    suggestions.classList.remove('show');
                }
                validateForm();
            });

            input.addEventListener('focus', () => { if (input.value.trim()) input.dispatchEvent(new Event('input')); });
            document.addEventListener('click', (e) => { if (!e.target.closest('.labo-selector')) suggestions.classList.remove('show'); });
        }

        // ‚îÄ‚îÄ‚îÄ TRAITEMENT IMAGE : compression + filtre scan N&B ‚îÄ‚îÄ‚îÄ
        function processImage(dataURL, callback) {
            const img = new Image();
            img.onload = () => {
                // Redimensionner √† 1400px max (lisible, ~200-300 Ko)
                const MAX = 1400;
                let w = img.width, h = img.height;
                if (w > MAX || h > MAX) {
                    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
                    else       { w = Math.round(w * MAX / h); h = MAX; }
                }

                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');

                // Dessiner l'image
                ctx.drawImage(img, 0, 0, w, h);

                // ‚îÄ‚îÄ Filtre scan N&B ‚îÄ‚îÄ
                const imgData = ctx.getImageData(0, 0, w, h);
                const d = imgData.data;
                for (let i = 0; i < d.length; i += 4) {
                    // Luminosit√© pond√©r√©e (yeux humains)
                    let gray = 0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2];
                    // Contraste fort pour effet scan (courbe S)
                    gray = Math.min(255, Math.max(0, (gray - 128) * 1.6 + 148));
                    d[i] = d[i+1] = d[i+2] = gray;
                }
                ctx.putImageData(imgData, 0, 0);

                // Compression JPEG qualit√© 0.82
                callback(canvas.toDataURL('image/jpeg', 0.82));
            };
            img.src = dataURL;
        }

        // ‚îÄ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ‚îÄ
        function setupPhotoCapture() {
            const zone = document.getElementById('photoZone');
            const input = document.getElementById('photoInput');
            zone.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const isPdf = file.type === 'application/pdf';
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        if (isPdf) {
                            // PDF : pas de traitement canvas, on garde tel quel
                            state.photos.push({ data: ev.target.result, name: file.name, type: file.type, isPdf: true, timestamp: new Date().toISOString() });
                            renderPhotos(); validateForm();
                        } else {
                            // Image : compression + filtre scan
                            processImage(ev.target.result, (processed) => {
                                state.photos.push({ data: processed, name: file.name, type: 'image/jpeg', isPdf: false, timestamp: new Date().toISOString() });
                                renderPhotos(); validateForm();
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            });
        }

        function renderPhotos() {
            document.getElementById('photosGrid').innerHTML = state.photos.map((p, i) => {
                if (p.isPdf) {
                    return `
                        <div class="photo-thumb photo-thumb-pdf">
                            <div class="pdf-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor" font-weight="bold">PDF</text>
                                </svg>
                            </div>
                            <span class="photo-thumb-badge">${i + 1}</span>
                            <button class="photo-thumb-remove" onclick="removePhoto(${i})">√ó</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="photo-thumb">
                            <img src="${p.data}" alt="BL page ${i + 1}">
                            <span class="photo-thumb-badge">${i + 1}</span>
                            <button class="photo-thumb-remove" onclick="removePhoto(${i})">√ó</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removePhoto(i) { state.photos.splice(i, 1); renderPhotos(); validateForm(); }



        // ‚îÄ‚îÄ‚îÄ VALIDATION ‚îÄ‚îÄ‚îÄ
        function setupFormValidation() {
            ['laboInput', 'receptInput'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));
            document.getElementById('btnSubmit').addEventListener('click', submitReception);
        }

        function validateForm() {
            const ok = document.getElementById('laboInput').value.trim() && document.getElementById('receptInput').value.trim() && state.photos.length > 0;
            document.getElementById('btnSubmit').disabled = !ok;
        }



        // ‚îÄ‚îÄ‚îÄ SUBMIT RECEPTION ‚îÄ‚îÄ‚îÄ
        async function submitReception() {
            const btn = document.getElementById('btnSubmit');
            const url = getVal('mlp_webhook_url');
            if (!url) { showToast('Configurez le webhook dans R√©glages', 'error'); return; }

            btn.classList.add('loading');
            btn.disabled = true;

            const labo     = document.getElementById('laboInput').value.trim().toUpperCase();
            const receptionnaire = document.getElementById('receptInput').value.trim();
            const now      = new Date();
            const dateISO  = now.toISOString();
            // Format date pour le nom de fichier : JJ-MM-AAAA_HH-MM
            const dd      = String(now.getDate()).padStart(2,'0');
            const mm      = String(now.getMonth()+1).padStart(2,'0');
            const yyyy    = now.getFullYear();
            const hh      = String(now.getHours()).padStart(2,'0');
            const min     = String(now.getMinutes()).padStart(2,'0');
            const dateStr = `${dd}-${mm}-${yyyy}_${hh}-${min}`;

            const laboSlug = labo.replace(/[^A-Z0-9]/g, '_');

            const payload = {
                labo,
                receptionnaire,
                date: dateISO,
                site: state.site,
                photos: state.photos.map((p, i) => {
                    const [header, base64] = p.data.split(',');
                    const mimeType = header.replace('data:', '').replace(';base64', '');

                    const ext = p.isPdf ? 'pdf'
                              : mimeType.includes('png') ? 'png'
                              : mimeType.includes('webp') ? 'webp'
                              : 'jpg';

                    // Nom de fichier : BL_BIOGARAN_XAVIER_15-02-2026_22-45_p1.jpg
                    const receptSlug = receptionnaire.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
                    const filename = `BL_${laboSlug}_${receptSlug}_${dateStr}_p${i + 1}.${ext}`;

                    return {
                        index:    i + 1,
                        data:     base64,
                        mimeType: mimeType,
                        filename: filename,
                        isPdf:    p.isPdf
                    };
                })
            };

            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    addToHistory({ labo: payload.labo, receptionnaire: payload.receptionnaire, date: payload.date, photoCount: state.photos.length, site: state.site });
                    document.getElementById('laboInput').value = '';
                    document.getElementById('receptInput').value = '';
                    state.photos = [];
                    renderPhotos();
                    showToast(`BL ${payload.labo} envoy√© sur Drive !`, 'success');
                } else {
                    showToast('Erreur ‚Äî v√©rifiez le webhook', 'error');
                }
            } catch (e) {
                showToast('Serveur n8n injoignable', 'error');
            }
            btn.classList.remove('loading');
            validateForm();
        }



        // ‚îÄ‚îÄ‚îÄ HISTORY (Google Sheets) ‚îÄ‚îÄ‚îÄ
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSi27F3vxSyQCFNv6MwxYaAQgyDVkkmQSQ333XEU6o-3UsLl-HzP_pDUdzWkng3lePxrxa2UAqt0zFL/pub?gid=0&single=true&output=csv';

        function addToHistory(entry) {
            // On ne stocke plus en local ‚Äî les donn√©es viennent du Sheet
            // Juste un refresh diff√©r√© apr√®s envoi
            setTimeout(loadSheetData, 3000);
        }

        function loadHistory() {
            // Chargement automatique au d√©marrage si on est sur le Dashboard
            loadSheetData();
        }

        async function loadSheetData() {
            const list   = document.getElementById('recentList');
            const status = document.getElementById('dashStatus');
            status.style.display = 'block';
            list.innerHTML = '';

            try {
                // Anti-cache
                const res  = await fetch(SHEET_CSV_URL + '&t=' + Date.now());
                const text = await res.text();
                const rows = parseCSV(text);

                if (rows.length <= 1) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>Aucune r√©ception enregistr√©e</p></div>';
                    document.getElementById('statToday').textContent = '0';
                    document.getElementById('statLabos').textContent = '0';
                    status.style.display = 'none';
                    return;
                }

                // Ignorer la ligne d'en-t√™te, inverser pour avoir le plus r√©cent en premier
                const data = rows.slice(1).reverse();

                // Stats du jour
                const today = new Date().toLocaleDateString('fr-FR');
                const todayRows = data.filter(r => {
                    // La date dans le sheet est en ISO ou JJ-MM-AAAA
                    const d = new Date(r[0]);
                    return d.toLocaleDateString('fr-FR') === today;
                });
                document.getElementById('statToday').textContent = todayRows.length;
                document.getElementById('statLabos').textContent = new Set(todayRows.map(r => r[1])).size;

                // Heure de derni√®re mise √† jour
                const now = new Date();
                document.getElementById('dashLastUpdate').textContent =
                    'M√†j ' + now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});

                // Liste des 30 derni√®res r√©ceptions
                list.innerHTML = data.slice(0, 30).map(r => {
                    const [dateRaw, labo, receptionnaire, nbPhotos] = r;
                    const d = new Date(dateRaw);
                    const dateStr = isNaN(d) ? dateRaw :
                        d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) + ' ' +
                        d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                    return `<div class="recent-item">
                        <div class="recent-item-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                        </div>
                        <div class="recent-item-info">
                            <div class="recent-item-title">${labo || '‚Äî'}</div>
                            <div class="recent-item-meta">${receptionnaire || '‚Äî'} ¬∑ ${nbPhotos || '?'} page(s) ¬∑ ${dateStr}</div>
                        </div>
                    </div>`;
                }).join('');

            } catch(e) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Impossible de charger les donn√©es</p></div>';
            }
            status.style.display = 'none';
        }

        // Parser CSV simple (g√®re les virgules dans les guillemets)
        function parseCSV(text) {
            return text.trim().split('\n').map(line => {
                const cols = [];
                let cur = '', inQ = false;
                for (let i = 0; i < line.length; i++) {
                    const c = line[i];
                    if (c === '"') { inQ = !inQ; }
                    else if (c === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
                    else { cur += c; }
                }
                cols.push(cur.trim());
                return cols;
            });
        }

        // ‚îÄ‚îÄ‚îÄ COMMANDES NAST.COM ‚îÄ‚îÄ‚îÄ
        const COMMANDES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRPfBopRiUpB5ymhHY2QzkVirEzHGKVisetSjatLeYprTGq1_9NP3J_fTWlr-hfmHhl5qI264SMLEu7/pub?gid=0&single=true&output=csv';
        const STATUTS_TRAITES = ['exp√©di√©','exp√©die','livr√©','livre','commande pr√™te','commande prete','rembours√© [payplug]','rembourse [payplug]','remboursement','itek'];

        let commandesData = [];
        let currentCommande = null;
        let scannerStream = null;
        let scannerInterval = null;
        let pickingState = {};

        async function loadCommandes() {
            const status = document.getElementById('commandesStatus');
            const list   = document.getElementById('commandesList');
            status.style.display = 'block';
            list.innerHTML = '';
            try {
                const res  = await fetch(COMMANDES_CSV + '&t=' + Date.now());
                const text = await res.text();
                const rows = parseCSV(text);
                if (rows.length < 2) {
                    list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚úÖ</div><p>Aucune commande √† traiter</p></div>';
                    status.style.display = 'none'; return;
                }
                const IDX = { num:0, ref:1, date:2, client:3, ville:4, cp:5, tel:6, statut:7, nb:8, total:9, idprod:10, ean:11, nom:12, qty:13 };
                const map = {};
                let lastNum = null; // garde le dernier num√©ro de commande vu

                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    const num = r[IDX.num]?.trim();

                    // Ligne avec num√©ro de commande = nouvelle commande
                    if (num) {
                        lastNum = num;
                        const statut = (r[IDX.statut] || '').trim().toLowerCase();
                        if (STATUTS_TRAITES.some(s => statut.includes(s))) {
                            lastNum = null; // marquer comme trait√©e, ignorer ses produits
                            continue;
                        }
                        map[num] = {
                            num, ref: r[IDX.ref], date: r[IDX.date], client: r[IDX.client],
                            ville: r[IDX.ville], statut: r[IDX.statut], total: r[IDX.total], produits: []
                        };
                    }

                    // Ligne produit (colonne A vide) : rattacher au dernier num√©ro connu
                    if (lastNum && map[lastNum] && r[IDX.ean]?.trim()) {
                        map[lastNum].produits.push({
                            ean: r[IDX.ean].trim(),
                            nom: r[IDX.nom]?.trim(),
                            qty: parseInt(r[IDX.qty]) || 1
                        });
                    }
                }
                commandesData = Object.values(map).sort((a, b) => new Date(b.date) - new Date(a.date));
                document.getElementById('commandesCount').textContent = commandesData.length + ' commande' + (commandesData.length > 1 ? 's' : '');
                if (!commandesData.length) {
                    list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚úÖ</div><p>Toutes les commandes sont trait√©es !</p></div>';
                } else {
                    renderCommandesList();
                }
            } catch(e) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚ö†Ô∏è</div><p>Impossible de charger les commandes</p></div>';
            }
            status.style.display = 'none';
        }

        function renderCommandesList() {
            const list = document.getElementById('commandesList');
            list.innerHTML = commandesData.map((c, idx) => {
                const d = new Date(c.date);
                const dateStr = isNaN(d) ? c.date : d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) + ' ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                const statut = c.statut?.trim() || '';
                const statutClass = statut.toLowerCase().includes('docmorris') ? 'statut-docmorris' : statut.toLowerCase().includes('payplug') ? 'statut-payplug' : 'statut-autre';
                return `<div class="commande-card" onclick="openCommandeDetail(${idx})">
                    <div class="commande-card-top">
                        <span class="commande-ref">#${c.num}</span>
                        <span class="commande-statut ${statutClass}">${statut}</span>
                    </div>
                    <div class="commande-client">${c.client || '‚Äî'}</div>
                    <div class="commande-meta">
                        <span>üì¶ ${c.produits.length} produit(s)</span>
                        <span>üìç ${c.ville || '‚Äî'}</span>
                        <span>üïê ${dateStr}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function openCommandeDetail(idx) {
            currentCommande = commandesData[idx];
            pickingState = {};
            currentCommande.produits.forEach(p => { pickingState[p.ean] = 0; });
            document.getElementById('commandesListView').classList.add('hidden');
            document.getElementById('commandeDetailView').classList.add('active');
            const d = new Date(currentCommande.date);
            const dateStr = isNaN(d) ? currentCommande.date : d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'short'}) + ' √† ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('detailRef').textContent = '#' + currentCommande.num + (currentCommande.ref ? ' ‚Äî ' + currentCommande.ref : '');
            document.getElementById('detailClient').textContent = 'üë§ ' + (currentCommande.client || '‚Äî') + (currentCommande.ville ? ' ¬∑ ' + currentCommande.ville : '');
            document.getElementById('detailDate').textContent = 'üïê ' + dateStr;
            renderProduitsDetail();
            updatePickingProgress();
        }

        function closeCommandeDetail() {
            stopScan();
            currentCommande = null;
            document.getElementById('commandesListView').classList.remove('hidden');
            document.getElementById('commandeDetailView').classList.remove('active');
        }

        function renderProduitsDetail() {
            const list = document.getElementById('produitsList');
            if (!currentCommande?.produits.length) {
                list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">Aucun produit trouv√©</div>';
                return;
            }
            list.innerHTML = currentCommande.produits.map((p, idx) => {
                const validated = pickingState[p.ean] || 0;
                const scanned   = validated > 0;
                return `<div class="produit-item ${scanned ? 'scanned' : ''}">
                    <div class="produit-check" onclick="showScanPopupByIndex(${idx})" style="cursor:pointer;">${scanned ? '‚úì' : ''}</div>
                    <div class="produit-info">
                        <div class="produit-nom">${p.nom || 'Produit'}</div>
                        <div class="produit-ean">${p.ean}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="produit-qty">${scanned ? validated + '/' : ''}√ó${p.qty}</span>
                        ${!scanned
                            ? `<button onclick="showScanPopupByIndex(${idx})" style="font-size:10px;padding:3px 8px;border:1px solid var(--border);border-radius:8px;background:white;color:var(--text-muted);cursor:pointer;">Valider</button>`
                            : `<button onclick="resetProduit('${p.ean}')" style="font-size:10px;padding:3px 8px;border:1px solid #fce4ec;border-radius:8px;background:#fce4ec;color:#E91E63;cursor:pointer;">Annuler</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        function updatePickingProgress() {
            if (!currentCommande) return;
            const total = currentCommande.produits.length;
            const done  = Object.values(pickingState).filter(v => v > 0).length;
            const pct   = total > 0 ? Math.round(done / total * 100) : 0;
            document.getElementById('pickingCount').textContent = done + ' / ' + total;
            const bar = document.getElementById('pickingBar');
            bar.style.width = pct + '%';
            bar.className = 'picking-bar-fill' + (done === total && total > 0 ? ' done' : '');
        }

        // ‚îÄ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ‚îÄ
        function startScan() {
            // Sur iOS Safari : input file avec capture d√©clenche la cam√©ra native
            // iOS lit les codes-barres automatiquement depuis iOS 15
            const inp = document.getElementById('scannerInput');
            inp.click();
        }

        function stopScan() {
            document.getElementById('scannerOverlay').classList.remove('active');
        }

        function handleScannerInput(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Lire l'image captur√©e et extraire le code-barre avec BarcodeDetector
            if ('BarcodeDetector' in window) {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = async () => {
                    try {
                        const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e'] });
                        const codes = await detector.detect(img);
                        URL.revokeObjectURL(url);
                        if (codes.length > 0) {
                            onBarcodeDetected(codes[0].rawValue);
                        } else {
                            showToast('Aucun code-barre d√©tect√© ‚Äî r√©essayez', 'error');
                        }
                    } catch(e) {
                        URL.revokeObjectURL(url);
                        showToast('Erreur de lecture', 'error');
                    }
                };
                img.src = url;
            } else {
                // Fallback iOS : lire les m√©tadonn√©es de l'image
                // iOS encode parfois le code-barre dans le nom du fichier
                // Sinon afficher saisie manuelle
                showManualInput();
            }
            // Reset pour permettre de scanner le m√™me code deux fois
            e.target.value = '';
        }

        function showManualInput() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.classList.add('active');
            document.getElementById('scannerResult').textContent = '';
            const existing = document.getElementById('scanFallback');
            if (existing) existing.remove();
            const wrap = document.createElement('div');
            wrap.id = 'scanFallback';
            wrap.style.cssText = 'margin-top:20px;display:flex;flex-direction:column;align-items:center;gap:12px;';
            wrap.innerHTML = '<p style="color:rgba(255,255,255,0.8);font-size:14px;text-align:center;padding:0 20px;">Saisissez le code-barre :</p>'
                + '<input type="number" inputmode="numeric" placeholder="3 083680 482035" style="padding:14px 18px;border-radius:12px;border:none;font-size:17px;width:280px;text-align:center;letter-spacing:1px;">';
            overlay.appendChild(wrap);
            const inp = wrap.querySelector('input');
            setTimeout(() => inp.focus(), 300);
            inp.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && inp.value.trim().length >= 8) {
                    onBarcodeDetected(inp.value.trim());
                    inp.value = '';
                    const fb = document.getElementById('scanFallback');
                    if (fb) fb.remove();
                    overlay.classList.remove('active');
                }
            });
        }


        function onBarcodeDetected(ean) {
            if (!currentCommande || !ean) return;

            // Normaliser l'EAN (enlever/ajouter z√©ro de t√™te)
            const eanStr = String(ean).trim();
            const produit = currentCommande.produits.find(p =>
                String(p.ean) === eanStr ||
                String(p.ean) === eanStr.replace(/^0+/, '') ||
                ('0' + String(p.ean)) === eanStr ||
                String(p.ean).replace(/^0+/, '') === eanStr.replace(/^0+/, '')
            );

            if (produit) {
                // Afficher popup de confirmation avec quantit√©
                showScanPopup(produit);
            } else {
                showToast('‚úó EAN non trouv√© : ' + eanStr, 'error');
                console.log('EAN scann√©:', eanStr, '‚Äî EANs dispo:', currentCommande.produits.map(p => p.ean));
            }
        }

        function showScanPopupByIndex(idx) {
            const p = currentCommande?.produits[idx];
            if (p) showScanPopup(p);
        }

        function resetProduit(ean) {
            pickingState[ean] = 0;
            renderProduitsDetail();
            updatePickingProgress();
        }

        function showScanPopup(produit) {
            const existing = document.getElementById('scanPopup');
            if (existing) existing.remove();

            const alreadyDone = pickingState[produit.ean] || 0;
            const defaultQty  = produit.qty || 1;
            const popup = document.createElement('div');
            popup.id = 'scanPopup';
            popup.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:500;display:flex;align-items:flex-end;justify-content:center;';
            popup.innerHTML = `
                <div style="background:white;border-radius:24px 24px 0 0;padding:24px 20px 40px;width:100%;max-width:480px;">
                    <div style="width:40px;height:4px;background:#e8ecf0;border-radius:2px;margin:0 auto 20px;"></div>
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:11px;color:#9aa8b8;font-family:monospace;margin-bottom:6px;">${produit.ean}</div>
                        <div style="font-size:15px;font-weight:600;color:#1a2332;line-height:1.4;padding:0 10px;">${produit.nom || 'Produit'}</div>
                        <div style="margin-top:8px;font-size:13px;color:#5a6a7e;">Qt√© attendue : <strong style="color:#1a2332;">${produit.qty}</strong>${alreadyDone ? ' ¬∑ <span style="color:#26C6DA;">‚úì D√©j√† valid√© (' + alreadyDone + ')</span>' : ''}</div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:center;gap:24px;margin-bottom:24px;">
                        <button id="popupMinus" style="width:48px;height:48px;border-radius:50%;border:2px solid #e8ecf0;background:white;font-size:24px;cursor:pointer;color:#1a2332;">‚àí</button>
                        <div style="text-align:center;">
                            <div id="scanQtyValue" style="font-size:42px;font-weight:700;color:#E91E63;line-height:1;">${defaultQty}</div>
                            <div style="font-size:11px;color:#9aa8b8;margin-top:2px;">quantit√©</div>
                        </div>
                        <button id="popupPlus" style="width:48px;height:48px;border-radius:50%;border:2px solid #e8ecf0;background:white;font-size:24px;cursor:pointer;color:#1a2332;">+</button>
                    </div>
                    <button id="popupValider" style="width:100%;padding:16px;background:#E91E63;color:white;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;margin-bottom:10px;">‚úì Valider</button>
                    <button id="popupAnnuler" style="width:100%;padding:13px;background:#f2f5f8;color:#5a6a7e;border:none;border-radius:14px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;">Annuler</button>
                </div>`;
            document.body.appendChild(popup);

            // Logique boutons ‚Äî sans passer par attributs onclick
            let qty = defaultQty;
            popup.querySelector('#popupMinus').addEventListener('click', () => { qty = Math.max(1, qty - 1); popup.querySelector('#scanQtyValue').textContent = qty; });
            popup.querySelector('#popupPlus').addEventListener('click',  () => { qty = qty + 1; popup.querySelector('#scanQtyValue').textContent = qty; });
            popup.querySelector('#popupValider').addEventListener('click', () => {
                popup.remove();
                pickingState[produit.ean] = qty;
                renderProduitsDetail();
                updatePickingProgress();
                const done  = Object.values(pickingState).filter(v => v > 0).length;
                const total = currentCommande.produits.length;
                showToast(done === total ? '‚úÖ Picking complet !' : '‚úì Produit valid√©', 'success');
            });
            popup.querySelector('#popupAnnuler').addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => { if (e.target === popup) popup.remove(); });
        }





        // ‚îÄ‚îÄ‚îÄ COMMANDES MLP ‚îÄ‚îÄ‚îÄ
        const MLP_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXlvAmyixl9AHfofVt6Lip-r3MLrbaVUh9odTblPnG0-EYrdupt82i7ZvhWMRqldndcVawJh9tJCJu/pub?gid=942322525&single=true&output=csv';

        let mlpData = [];
        let currentMlp = null;
        let mlpPickingState = {};

        async function loadMLP() {
            const status = document.getElementById('mlpStatus');
            const list   = document.getElementById('mlpList');
            status.style.display = 'block';
            list.innerHTML = '';
            try {
                const res  = await fetch(MLP_CSV + '&t=' + Date.now());
                const text = await res.text();
                const rows = parseCSV(text);
                if (rows.length < 2) {
                    list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚úÖ</div><p>Aucune commande √† traiter</p></div>';
                    status.style.display = 'none'; return;
                }
                const IDX = { num:0, ref:1, date:2, client:3, ville:4, cp:5, tel:6, statut:7, nb:8, total:9, idprod:10, ean:11, nom:12, qty:13 };
                const map = {};
                let lastNum = null;
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    const num = r[IDX.num]?.trim();
                    if (num) {
                        lastNum = num;
                        const statut = (r[IDX.statut] || '').trim().toLowerCase();
                        if (STATUTS_TRAITES.some(s => statut.includes(s))) { lastNum = null; continue; }
                        map[num] = { num, ref: r[IDX.ref], date: r[IDX.date], client: r[IDX.client], ville: r[IDX.ville], statut: r[IDX.statut], total: r[IDX.total], produits: [] };
                    }
                    if (lastNum && map[lastNum] && r[IDX.ean]?.trim()) {
                        map[lastNum].produits.push({ ean: r[IDX.ean].trim(), nom: r[IDX.nom]?.trim(), qty: parseInt(r[IDX.qty]) || 1 });
                    }
                }
                mlpData = Object.values(map).sort((a, b) => new Date(b.date) - new Date(a.date));
                document.getElementById('mlpCount').textContent = mlpData.length + ' commande' + (mlpData.length > 1 ? 's' : '');
                if (!mlpData.length) {
                    list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚úÖ</div><p>Toutes trait√©es !</p></div>';
                } else {
                    renderMlpList();
                }
            } catch(e) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚ö†Ô∏è</div><p>Impossible de charger</p></div>';
            }
            status.style.display = 'none';
        }

        function renderMlpList() {
            const list = document.getElementById('mlpList');
            list.innerHTML = mlpData.map((c, idx) => {
                const d = new Date(c.date);
                const dateStr = isNaN(d) ? c.date : d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) + ' ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                const statut = c.statut?.trim() || '';
                const statutClass = statut.toLowerCase().includes('docmorris') ? 'statut-docmorris' : statut.toLowerCase().includes('payplug') ? 'statut-payplug' : 'statut-autre';
                return `<div class="commande-card" onclick="openMlpDetail(${idx})">
                    <div class="commande-card-top">
                        <span class="commande-ref">#${c.num}</span>
                        <span class="commande-statut ${statutClass}">${statut}</span>
                    </div>
                    <div class="commande-client">${c.client || '‚Äî'}</div>
                    <div class="commande-meta">
                        <span>üì¶ ${c.produits.length} produit(s)</span>
                        <span>üìç ${c.ville || '‚Äî'}</span>
                        <span>üïê ${dateStr}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function openMlpDetail(idx) {
            currentMlp = mlpData[idx];
            mlpPickingState = {};
            currentMlp.produits.forEach(p => { mlpPickingState[p.ean] = 0; });
            document.getElementById('mlpListView').classList.add('hidden');
            document.getElementById('mlpDetailView').classList.add('active');
            const d = new Date(currentMlp.date);
            const dateStr = isNaN(d) ? currentMlp.date : d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'short'}) + ' √† ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('mlpDetailRef').textContent = '#' + currentMlp.num + (currentMlp.ref ? ' ‚Äî ' + currentMlp.ref : '');
            document.getElementById('mlpDetailClient').textContent = 'üë§ ' + (currentMlp.client || '‚Äî') + (currentMlp.ville ? ' ¬∑ ' + currentMlp.ville : '');
            document.getElementById('mlpDetailDate').textContent = 'üïê ' + dateStr;
            renderMlpProduits();
            updateMlpProgress();
        }

        function closeMlpDetail() {
            currentMlp = null;
            document.getElementById('mlpListView').classList.remove('hidden');
            document.getElementById('mlpDetailView').classList.remove('active');
        }

        function renderMlpProduits() {
            const list = document.getElementById('mlpProduitsList');
            if (!currentMlp?.produits.length) { list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">Aucun produit</div>'; return; }
            list.innerHTML = currentMlp.produits.map(p => {
                const validated = mlpPickingState[p.ean] || 0;
                const scanned = validated > 0;
                return `<div class="produit-item ${scanned ? 'scanned' : ''}">
                    <div class="produit-check" onclick="showMlpPopup(${JSON.stringify(p).replace(/"/g,'&quot;')})" style="cursor:pointer;">${scanned ? '‚úì' : ''}</div>
                    <div class="produit-info">
                        <div class="produit-nom">${p.nom || 'Produit'}</div>
                        <div class="produit-ean">${p.ean}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="produit-qty">${scanned ? validated + '/' : ''}√ó${p.qty}</span>
                        ${!scanned ? `<button onclick="showMlpPopup(${JSON.stringify(p).replace(/"/g,'&quot;')})" style="font-size:10px;padding:3px 8px;border:1px solid var(--border);border-radius:8px;background:white;color:var(--text-muted);cursor:pointer;">Valider</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function updateMlpProgress() {
            if (!currentMlp) return;
            const total = currentMlp.produits.length;
            const done  = Object.values(mlpPickingState).filter(v => v > 0).length;
            const pct   = total > 0 ? Math.round(done / total * 100) : 0;
            document.getElementById('mlpPickingCount').textContent = done + ' / ' + total;
            const bar = document.getElementById('mlpPickingBar');
            bar.style.width = pct + '%';
            bar.className = 'picking-bar-fill' + (done === total && total > 0 ? ' done' : '');
        }

        function startMlpScan() {
            document.getElementById('mlpScannerInput').click();
        }

        function handleMlpScannerInput(e) {
            const file = e.target.files[0];
            if (!file) return;
            if ('BarcodeDetector' in window) {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = async () => {
                    try {
                        const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e'] });
                        const codes = await detector.detect(img);
                        URL.revokeObjectURL(url);
                        if (codes.length > 0) { onMlpBarcodeDetected(codes[0].rawValue); }
                        else { showToast('Aucun code-barre d√©tect√©', 'error'); }
                    } catch(err) { URL.revokeObjectURL(url); showToast('Erreur lecture', 'error'); }
                };
                img.src = url;
            } else {
                showToast('Scanner non disponible', 'error');
            }
            e.target.value = '';
        }

        function onMlpBarcodeDetected(ean) {
            if (!currentMlp || !ean) return;
            const eanStr = String(ean).trim();
            const produit = currentMlp.produits.find(p =>
                String(p.ean) === eanStr ||
                String(p.ean) === eanStr.replace(/^0+/, '') ||
                ('0' + String(p.ean)) === eanStr ||
                String(p.ean).replace(/^0+/, '') === eanStr.replace(/^0+/, '')
            );
            if (produit) { showMlpPopup(produit); }
            else { showToast('‚úó EAN non trouv√© : ' + eanStr, 'error'); }
        }

        function showMlpPopup(produit) {
            const existing = document.getElementById('scanPopup');
            if (existing) existing.remove();
            const popup = document.createElement('div');
            popup.id = 'scanPopup';
            popup.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;display:flex;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom,0px);';
            popup.innerHTML = `
                <div style="background:white;border-radius:24px 24px 0 0;padding:24px 20px 32px;width:100%;max-width:480px;">
                    <div style="text-align:center;margin-bottom:16px;">
                        <div style="font-size:13px;color:#9aa8b8;font-family:monospace;margin-bottom:4px;">${produit.ean}</div>
                        <div style="font-size:15px;font-weight:600;color:#1a2332;line-height:1.3;">${produit.nom || 'Produit'}</div>
                        <div style="margin-top:6px;font-size:13px;color:#5a6a7e;">Quantit√© attendue : <strong>${produit.qty}</strong></div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;">
                        <button onclick="changeScanQty(-1)" style="width:44px;height:44px;border-radius:50%;border:2px solid #e8ecf0;background:white;font-size:22px;cursor:pointer;">‚àí</button>
                        <div style="text-align:center;">
                            <div id="scanQtyValue" style="font-size:36px;font-weight:700;color:#E91E63;line-height:1;">${produit.qty}</div>
                            <div style="font-size:11px;color:#9aa8b8;">quantit√©</div>
                        </div>
                        <button onclick="changeScanQty(1)" style="width:44px;height:44px;border-radius:50%;border:2px solid #e8ecf0;background:white;font-size:22px;cursor:pointer;">+</button>
                    </div>
                    <button onclick="validateMlpScan('${produit.ean}')" style="width:100%;padding:16px;background:#E91E63;color:white;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;margin-bottom:10px;">‚úì Valider</button>
                    <button onclick="document.getElementById('scanPopup').remove()" style="width:100%;padding:12px;background:#f2f5f8;color:#5a6a7e;border:none;border-radius:14px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;">Annuler</button>
                </div>`;
            popup.dataset.ean = produit.ean;
            popup.dataset.qty = produit.qty;
            document.body.appendChild(popup);
            popup.addEventListener('click', (e) => { if (e.target === popup) popup.remove(); });
        }

        function validateMlpScan(ean) {
            const popup = document.getElementById('scanPopup');
            if (!popup) return;
            const qty = parseInt(popup.dataset.qty) || 1;
            popup.remove();
            mlpPickingState[ean] = qty;
            renderMlpProduits();
            updateMlpProgress();
            const total = currentMlp.produits.length;
            const done  = Object.values(mlpPickingState).filter(v => v > 0).length;
            showToast(done === total ? '‚úÖ Picking MLP complet !' : '‚úì Produit valid√©', 'success');
        }


        // ‚îÄ‚îÄ‚îÄ SAV MLP ‚îÄ‚îÄ‚îÄ
        const SAV_SHEET_ID = '11NfsGe3PgMqb-3u9MCbNZ9yLYiPBDJkvwz_1qlY3NC0';
        const SAV_CSV = `https://docs.google.com/spreadsheets/d/e/2PACX-1v${SAV_SHEET_ID.substring(0,10)}/pub?gid=0&single=true&output=csv`;

        // URL CSV publique ‚Äî √† renseigner une fois le sheet publi√©
        const SAV_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTX-NhvRrb0qvFaVabf_bDzFUiZ9Iy0YDhxPcamxXxom4VT1cETJk57EUVZiYHqLN-L29A0TfKGCn6e/pub?gid=0&single=true&output=csv';

        let savData = [];
        let savFiltre = 'tous';
        let currentTicket = null;

        async function loadSAV() {
            const status = document.getElementById('savStatus');
            const list   = document.getElementById('savList');
            status.style.display = 'block';
            list.innerHTML = '';
            try {
                const res  = await fetch(SAV_CSV_URL + '&t=' + Date.now());
                const text = await res.text();
                const rows = parseCSV(text);
                if (rows.length < 2) {
                    list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">üí¨</div><p>Aucun ticket SAV</p></div>';
                    status.style.display = 'none'; return;
                }
                // Colonnes : id_mail(0) date(1) expediteur(2) sujet(3) corps(4) statut(5) thread_id(6) historique(7)
                // D√©dupliquer par id_mail (garder le plus r√©cent)
                const uniqueMap = {};
                rows.slice(1)
                    .filter(r => r[0]?.trim())
                    .filter(r => {
                        const exp = r[2]?.trim() || '';
                        const sujet = r[3]?.trim() || '';
                        return exp !== 'undefined' && sujet !== 'undefined' && exp.includes('@');
                    })
                    .forEach(r => {
                        const id = r[0].trim();
                        const date = new Date(r[1]?.trim());
                        if (!uniqueMap[id] || date > new Date(uniqueMap[id].date)) {
                            uniqueMap[id] = {
                                id: id,
                                date: r[1]?.trim(),
                                expediteur: r[2]?.trim(),
                                sujet: r[3]?.trim() || '(sans objet)',
                                corps: r[4]?.trim().replace(/\\n/g, '\n'),
                                statut: r[5]?.trim() || 'nouveau',
                                thread_id: r[6]?.trim(),
                                historique: (() => {
                                    try {
                                        const h = JSON.parse(r[7] || '[]');
                                        return h.map(m => ({ ...m, message: (m.message || '').replace(/\\n/g, '\n') }));
                                    } catch(e) { return []; }
                                })()
                            };
                        }
                    });
                savData = Object.values(uniqueMap).sort((a, b) => new Date(b.date) - new Date(a.date));

                const nouveaux = savData.filter(t => t.statut === 'nouveau').length;
                document.getElementById('savCount').textContent = savData.length + ' ticket' + (savData.length > 1 ? 's' : '') + (nouveaux ? ` ¬∑ ${nouveaux} üî¥` : '');
                renderSavList();
            } catch(e) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚ö†Ô∏è</div><p>Impossible de charger le SAV<br><small>V√©rifiez que le Sheet est publi√©</small></p></div>';
            }
            status.style.display = 'none';
        }

        function filterSAV(filtre, btn) {
            savFiltre = filtre;
            document.querySelectorAll('.sav-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderSavList();
        }

        function renderSavList() {
            const list = document.getElementById('savList');
            const filtered = savFiltre === 'tous' ? savData : savData.filter(t => t.statut === savFiltre);
            if (!filtered.length) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">üí¨</div><p>Aucun ticket</p></div>';
                return;
            }
            list.innerHTML = filtered.map((t, i) => {
                const idx = savData.indexOf(t);
                const d = new Date(t.date);
                const dateStr = isNaN(d) ? t.date : d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) + ' ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                const badgeClass = `sav-badge-${t.statut.replace('√©','e').replace('√ª','u')}` || 'sav-badge-nouveau';
                
                // Extraire le vrai message sans les ic√¥nes et labels
                let preview = t.corps || '';
                const lines = preview.split('\n').filter(l => !l.startsWith('üìß') && !l.startsWith('üì¶'));
                preview = lines.join(' ').substring(0, 100);
                
                return `<div class="sav-ticket" onclick="openSavDetail(${idx})">
                    <div class="sav-ticket-top">
                        <div class="sav-ticket-sujet">${t.sujet}</div>
                        <span class="sav-badge ${badgeClass}">${t.statut}</span>
                    </div>
                    <div class="sav-ticket-from">‚úâ ${t.expediteur}</div>
                    <div class="sav-ticket-preview">${preview}‚Ä¶</div>
                    <div class="sav-ticket-date">üïê ${dateStr}</div>
                </div>`;
            }).join('');
        }

        function openSavDetail(idx) {
            currentTicket = savData[idx];
            document.getElementById('savListView').classList.add('hidden');
            document.getElementById('savDetailView').classList.add('active');
            const d = new Date(currentTicket.date);
            const dateStr = isNaN(d) ? currentTicket.date : d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'long'}) + ' √† ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('savDetailSujet').textContent = currentTicket.sujet;
            document.getElementById('savDetailFrom').textContent = '‚úâ ' + currentTicket.expediteur;
            document.getElementById('savDetailDate').textContent = 'üïê ' + dateStr;
            document.getElementById('savReplyArea').value = '';
            document.getElementById('savBtnResolu').style.display = currentTicket.statut === 'r√©solu' ? 'none' : 'block';
            renderSavFil();
        }

        function closeSavDetail() {
            currentTicket = null;
            document.getElementById('savListView').classList.remove('hidden');
            document.getElementById('savDetailView').classList.remove('active');
        }

        function renderSavFil() {
            const fil = document.getElementById('savFil');
            if (!currentTicket) return;
            const msgs = currentTicket.historique.length > 0
                ? currentTicket.historique
                : [{ role: 'client', date: currentTicket.date, de: currentTicket.expediteur, message: currentTicket.corps }];
            fil.innerHTML = msgs.map(m => {
                const isNous = m.role === 'nous';
                const d = new Date(m.date);
                const dateStr = isNaN(d) ? '' : d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) + ' ¬∑ ' + d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
                // Convertir \n en <br> pour l'affichage
                let msg = m.message || '';
                msg = msg.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                msg = msg.replace(/\\n/g,'\n').replace(/\n/g,'<br>');
                return `<div style="display:flex;flex-direction:column;align-items:${isNous ? 'flex-end' : 'flex-start'};">
                    <div class="sav-msg ${isNous ? 'sav-msg-nous' : 'sav-msg-client'}">
                        ${msg}
                        <div class="sav-msg-meta">${isNous ? 'Vous' : (m.de || 'Client')} ¬∑ ${dateStr}</div>
                    </div>
                </div>`;
            }).join('');
            setTimeout(() => fil.scrollTop = fil.scrollHeight, 100);
        }

        async function suggererReponseIA() {
            if (!currentTicket) return;
            
            const webhookUrl = getVal('sav_webhook_url');
            if (!webhookUrl) {
                showToast('‚ö†Ô∏è Webhook SAV non configur√©', 'error');
                return;
            }
            
            const iaWebhookUrl = webhookUrl.replace('sav-reply-mlp', 'sav-ia-mlp');
            const loading = document.getElementById('iaLoading');
            const area    = document.getElementById('savReplyArea');
            
            loading.style.display = 'block';
            area.value = '';

            try {
                const response = await fetch(iaWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        expediteur: currentTicket.expediteur,
                        sujet: currentTicket.sujet,
                        corps: currentTicket.corps
                    })
                });
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                area.value = data.reponse || 'Erreur lors de la g√©n√©ration';
            } catch(e) {
                area.value = 'Erreur de connexion √† l\'IA : ' + e.message;
            }
            
            loading.style.display = 'none';
        }

        async function envoyerReponse() {
            const area = document.getElementById('savReplyArea');
            const msg  = area.value.trim();
            if (!msg || !currentTicket) return;

            const webhookUrl = getVal('sav_webhook_url');
            if (!webhookUrl) {
                showToast('‚ö†Ô∏è Webhook SAV non configur√© dans les R√©glages', 'error');
                return;
            }

            const btnSend = document.querySelector('.btn-send');
            btnSend.textContent = 'Envoi‚Ä¶';
            btnSend.disabled = true;

            try {
                const res = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_mail:    currentTicket.id,
                        thread_id:  currentTicket.thread_id,
                        expediteur: currentTicket.expediteur,
                        sujet:      currentTicket.sujet,
                        reponse:    msg
                    })
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const newMsg = { role: 'nous', date: new Date().toISOString(), de: 'My Little Para', message: msg };
                currentTicket.historique.push(newMsg);
                currentTicket.statut = 'en_cours';
                renderSavFil();
                area.value = '';
                showToast('‚úÖ R√©ponse envoy√©e !', 'success');
            } catch(e) {
                showToast('‚ùå Erreur envoi : ' + e.message, 'error');
            }
            btnSend.textContent = 'Envoyer ‚Üí';
            btnSend.disabled = false;
        }

        async function marquerResolu() {
            if (!currentTicket) return;
            const webhookUrl = getVal('sav_webhook_url');
            if (webhookUrl) {
                try {
                    await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_mail: currentTicket.id, thread_id: currentTicket.thread_id, expediteur: currentTicket.expediteur, sujet: currentTicket.sujet, reponse: null, statut: 'r√©solu' })
                    });
                } catch(e) {}
            }
            currentTicket.statut = 'r√©solu';
            document.getElementById('savBtnResolu').style.display = 'none';
            showToast('‚úÖ Ticket marqu√© comme r√©solu', 'success');
        }


        function switchSubtab(section, panel, btn) {
            // Legacy ‚Äî redirig√© vers switchSection
            return;
            
            // Charger les donn√©es si TODO
            if (panel === 'todo') {
                if (section === 'nast') loadTodoNast();
                else loadTodoWeb();
            }
        }


        // ‚îÄ‚îÄ‚îÄ TODO NAST + WEB ‚îÄ‚îÄ‚îÄ
        const TODO_NAST_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRz7fq6cq5pZMIgml9xH9ClgY1mMgDnEK9oYVSQ9etzh4jOLmUzWvjyMBJGzugeiX5QKDfKfNMcXxhw/pub?gid=0&single=true&output=csv';
        const TODO_WEB_CSV  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKq6-JJ5AreXcuX6HBSjkcIRhmC5rWLv--KgUijpRz9bOfQYKo63bP16hUc96tLcgMQaf3DetfRX2I/pub?gid=0&single=true&output=csv';
        const TODO_NAST_SHEET = '1-6xsf6ukxmba2fRwnsqZeIXYq9oOL9h9uEIvJQ9fhIU';
        const TODO_WEB_SHEET  = '1MJhApWfHs9BTlatv6ME3rv1tbBiFUA4tuW8bCC5DxbQ';

        let todoNastData = [];
        let todoWebData  = [];
        let todoNastFiltre = 'tous';
        let todoWebFiltre  = 'tous';

        function genTodoId() { return Date.now().toString(36) + Math.random().toString(36).substring(2,6); }

        async function loadTodoGeneric(csvUrl, statusId, listId, storeVar) {
            const status = document.getElementById(statusId);
            const list   = document.getElementById(listId);
            status.style.display = 'block';
            list.innerHTML = '';
            try {
                const res  = await fetch(csvUrl + '&t=' + Date.now());
                const text = await res.text();
                const rows = parseCSV(text);
                // Colonnes : id(0) titre(1) priorite(2) notes(3) statut(4) date_ajout(5) date_resolution(6) assigne_a(7)
                const data = rows.slice(1)
                    .filter(r => r[0]?.trim() && r[1]?.trim())
                    .map(r => ({
                        id: r[0].trim(),
                        titre: r[1].trim(),
                        priorite: (r[2]?.trim() || 'normal').toLowerCase(),
                        notes: r[3]?.trim() || '',
                        statut: (r[4]?.trim() || 'todo').toLowerCase(),
                        date: r[5]?.trim(),
                        date_resolution: r[6]?.trim() || '',
                        assigne_a: r[7]?.trim() || ''
                    }))
                    .sort((a,b) => {
                        // √Ä faire en haut, r√©solues en bas
                        if (a.statut === 'done' && b.statut !== 'done') return 1;
                        if (a.statut !== 'done' && b.statut === 'done') return -1;
                        // Parmi les √† faire : urgent d'abord
                        if (a.statut !== 'done' && b.statut !== 'done') {
                            if (a.priorite === 'urgent' && b.priorite !== 'urgent') return -1;
                            if (a.priorite !== 'urgent' && b.priorite === 'urgent') return 1;
                        }
                        return new Date(b.date || 0) - new Date(a.date || 0);
                    });
                return data;
            } catch(e) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚ö†Ô∏è</div><p>Impossible de charger</p></div>';
                return [];
            } finally {
                status.style.display = 'none';
            }
        }

        async function loadTodoNast() {
            todoNastData = await loadTodoGeneric(TODO_NAST_CSV, 'todoNastStatus', 'todoNastList');
            renderTodo('nast');
        }

        async function loadTodoWeb() {
            todoWebData = await loadTodoGeneric(TODO_WEB_CSV, 'todoWebStatus', 'todoWebList');
            renderTodo('web');
        }

        function filterTodo(type, filtre, btn) {
            if (type === 'nast') todoNastFiltre = filtre;
            else todoWebFiltre = filtre;
            // Reset active sur les filtres du m√™me panel
            btn.closest('.todo-filters').querySelectorAll('.todo-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTodo(type);
        }

        function renderTodo(type) {
            const data   = type === 'nast' ? todoNastData : todoWebData;
            const filtre = type === 'nast' ? todoNastFiltre : todoWebFiltre;
            const listId = type === 'nast' ? 'todoNastList' : 'todoWebList';
            const list   = document.getElementById(listId);

            let filtered = data;
            if (filtre === 'done')   filtered = data.filter(t => t.statut === 'done');
            else if (filtre === 'urgent') filtered = data.filter(t => t.priorite === 'urgent' && t.statut !== 'done');
            else if (filtre === 'normal') filtered = data.filter(t => t.priorite === 'normal' && t.statut !== 'done');
            // 'tous' = tout afficher, √† faire en haut + r√©solues gris√©es en bas
            // Le tri est d√©j√† fait dans loadTodoGeneric

            if (!filtered.length) {
                list.innerHTML = '<div class="commande-empty"><div class="commande-empty-icon">‚úÖ</div><p>Aucune t√¢che</p></div>';
                return;
            }

            const prioLabels = { urgent: 'üî¥ Urgent', normal: 'üîµ Normal', faible: 'üü£ Faible' };
            const prioClass  = { urgent: 'todo-prio-urgent', normal: 'todo-prio-normal', faible: 'todo-prio-faible' };

            list.innerHTML = filtered.map(t => {
                const done = t.statut === 'done';
                const d = new Date(t.date);
                const dateStr = isNaN(d) ? '' : d.toLocaleDateString('fr-FR', {day:'numeric', month:'short', year:'numeric'});
                const resolDate = t.date_resolution ? new Date(t.date_resolution) : null;
                const resolStr = resolDate && !isNaN(resolDate) ? resolDate.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) + ' ' + resolDate.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '';
                return `<div class="todo-card ${done ? 'done' : ''}">
                    <div class="todo-check ${done ? 'checked' : ''}" data-todo-type="${type}" data-todo-id="${t.id}">
                        ${done ? '‚úì' : ''}
                    </div>
                    <div class="todo-body">
                        <div class="todo-titre">${t.titre}</div>
                        ${t.notes ? `<div class="todo-notes">${t.notes}</div>` : ''}
                        <div class="todo-meta">
                            <span class="todo-prio ${prioClass[t.priorite] || 'todo-prio-normal'}">${prioLabels[t.priorite] || t.priorite}</span>
                            ${t.assigne_a ? `<span class="todo-date">üë§ ${t.assigne_a}</span>` : ''}
                            ${dateStr ? `<span class="todo-date">üìÖ ${dateStr}</span>` : ''}
                            ${done && resolStr ? `<span class="todo-date">‚úÖ ${resolStr}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');

            // Event delegation pour les checks
            list.querySelectorAll('.todo-check').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const todoType = el.dataset.todoType;
                    const todoId = el.dataset.todoId;
                    if (todoType && todoId) toggleTodo(todoType, todoId);
                });
            });
        }

        function toggleTodoForm(type) {
            const formId = (type === 'nast' || type === 'todoFormNast') ? 'todoFormNast' : 'todoFormWeb';
            const form = document.getElementById(formId);
            if(form) form.classList.toggle('visible');
        }

        async function saveTodoGeneric(type, sheetId) {
            const cap   = type === 'nast' ? 'Nast' : 'Web';
            const titre = document.getElementById(`todo${cap}Titre`).value.trim();
            const notes = document.getElementById(`todo${cap}Notes`).value.trim();
            const prio  = document.getElementById(`todo${cap}Prio`).value;
            if (!titre) { showToast('‚ö†Ô∏è Le titre est obligatoire', 'error'); return; }

            const id   = genTodoId();
            const date = new Date().toISOString();
            const newTask = { id, titre, priorite: prio, notes, statut: 'todo', date, date_resolution: '', assigne_a: '' };

            // Ajout local imm√©diat
            if (type === 'nast') todoNastData.unshift(newTask);
            else todoWebData.unshift(newTask);
            renderTodo(type);
            toggleTodoForm(type);
            document.getElementById(`todo${cap}Titre`).value = '';
            document.getElementById(`todo${cap}Notes`).value = '';
            showToast('‚úÖ T√¢che ajout√©e !', 'success');
            
            // Sync Sheet via webhook
            try {
                await fetch('https://n8n.srv1086994.hstgr.cloud/webhook/todo-manager', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        type, id, titre, priorite: prio, notes, 
                        statut: 'todo', date_ajout: date, 
                        date_resolution: '', assigne_a: '',
                        _update: false 
                    })
                });
            } catch(e) { showToast('‚ö†Ô∏è Sync Sheet √©chou√©e', 'error'); }
        }

        function saveTodoNast() { saveTodoGeneric('nast', TODO_NAST_SHEET); }
        function saveTodoWeb()  { saveTodoGeneric('web',  TODO_WEB_SHEET);  }

        async function toggleTodo(type, id) {
            const data = type === 'nast' ? todoNastData : todoWebData;
            const task = data.find(t => t.id === id);
            if (!task) return;
            
            const newStatut = task.statut === 'done' ? 'todo' : 'done';
            task.statut = newStatut;
            task.date_resolution = newStatut === 'done' ? new Date().toISOString() : '';
            renderTodo(type);

            // Webhook n8n pour update le Sheet
            try {
                await fetch('https://n8n.srv1086994.hstgr.cloud/webhook/todo-manager', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        type, 
                        id, 
                        statut: newStatut, 
                        date_resolution: task.date_resolution,
                        _update: true 
                    })
                });
            } catch(e) { console.error('Erreur sync TODO:', e); }
            
            showToast(newStatut === 'done' ? '‚úÖ T√¢che r√©solue !' : '‚Ü©Ô∏è T√¢che r√©ouverte', 'success');
        }


        function loadLabos() {
            try { const s = getVal('mlp_labos'); state.labos = s ? JSON.parse(s) : DEFAULT_LABOS; } catch (e) { state.labos = DEFAULT_LABOS; }
            document.getElementById('labosListInput').value = state.labos.join('\n');
        }

        // ‚îÄ‚îÄ‚îÄ STORAGE HELPERS ‚îÄ‚îÄ‚îÄ
        function getVal(k) { try { return localStorage.getItem(k) || ''; } catch (e) { return ''; } }
        function setVal(k, v) { try { localStorage.setItem(k, v); } catch (e) {} }

        // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            toast.querySelector('.toast-icon').textContent = type === 'error' ? '‚úï' : '‚úì';
            toast.className = `toast ${type}`;
            requestAnimationFrame(() => { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); });
        }

        // ‚îÄ‚îÄ‚îÄ SETTINGS Delpech ‚îÄ‚îÄ‚îÄ
        function setupSettings() {
            document.getElementById('btnSaveSettings').addEventListener('click', () => {
                setVal('mlp_webhook_url', document.getElementById('webhookUrlInput').value.trim());
                updateWebhookStatus();
                showToast('Param√®tres sauvegard√©s', 'success');
            });
            document.getElementById('btnSaveDelpechWebhook').addEventListener('click', () => {
                setVal('mlp_delpech_webhook_url', document.getElementById('webhookDelpechInput').value.trim());
                updateDelpechWebhookStatus();
                showToast('Webhook Delpech sauvegard√©', 'success');
            });
            document.getElementById('btnSaveSavWebhook').addEventListener('click', () => {
                setVal('sav_webhook_url', document.getElementById('webhookSavInput').value.trim());
                updateSavWebhookStatus();
                showToast('Webhook SAV sauvegard√©', 'success');
            });
            document.getElementById('btnSaveLabos').addEventListener('click', () => {
                state.labos = document.getElementById('labosListInput').value.split('\n').map(l => l.trim()).filter(Boolean).sort();
                setVal('mlp_labos', JSON.stringify(state.labos));
                document.getElementById('labosListInput').value = state.labos.join('\n');
                showToast(`${state.labos.length} labos sauvegard√©s`, 'success');
            });
        }

        function loadSettings() {
            const blUrl = getVal('mlp_webhook_url') || 'https://n8n.srv1086994.hstgr.cloud/webhook/reception-bl';
            const delpechUrl = getVal('mlp_delpech_webhook_url') || 'https://n8n.srv1086994.hstgr.cloud/webhook/delpech-preparatoire';
            const savUrl = getVal('sav_webhook_url') || 'https://n8n.srv1086994.hstgr.cloud/webhook/sav-reply-mlp';
            if (!getVal('mlp_webhook_url')) setVal('mlp_webhook_url', blUrl);
            if (!getVal('mlp_delpech_webhook_url')) setVal('mlp_delpech_webhook_url', delpechUrl);
            if (!getVal('sav_webhook_url')) setVal('sav_webhook_url', savUrl);
            document.getElementById('webhookUrlInput').value = blUrl;
            document.getElementById('webhookDelpechInput').value = delpechUrl;
            document.getElementById('webhookSavInput').value = savUrl;
            updateWebhookStatus();
            updateDelpechWebhookStatus();
            updateSavWebhookStatus();
        }

        function updateSavWebhookStatus() {
            const s = document.getElementById('webhookSavStatus');
            if (getVal('sav_webhook_url')) {
                s.className = 'webhook-status connected';
                s.innerHTML = '<span class="webhook-dot"></span>Connect√©';
            } else {
                s.className = 'webhook-status disconnected';
                s.innerHTML = '<span class="webhook-dot"></span>Non configur√©';
            }
        }

        function updateWebhookStatus() {
            const s = document.getElementById('webhookStatus');
            if (getVal('mlp_webhook_url')) {
                s.className = 'webhook-status connected';
                s.innerHTML = '<span class="webhook-dot"></span>Connect√©';
            } else {
                s.className = 'webhook-status disconnected';
                s.innerHTML = '<span class="webhook-dot"></span>Non configur√©';
            }
        }

        function updateDelpechWebhookStatus() {
            const s = document.getElementById('webhookDelpechStatus');
            if (getVal('mlp_delpech_webhook_url')) {
                s.className = 'webhook-status connected';
                s.innerHTML = '<span class="webhook-dot"></span>Connect√©';
            } else {
                s.className = 'webhook-status disconnected';
                s.innerHTML = '<span class="webhook-dot"></span>Non configur√©';
            }
        }

        // ‚îÄ‚îÄ‚îÄ DELPECH SETUP ‚îÄ‚îÄ‚îÄ
        function setupDelpech() {
            // Photos
            const zone = document.getElementById('delpechPhotoZone');
            const input = document.getElementById('delpechPhotoInput');
            zone.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const isPdf = file.type === 'application/pdf';
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        if (isPdf) {
                            delpechState.photos.push({ data: ev.target.result, name: file.name, type: file.type, isPdf: true, timestamp: new Date().toISOString() });
                            renderDelpechPhotos(); validateDelpechForm();
                        } else {
                            processImage(ev.target.result, (processed) => {
                                delpechState.photos.push({ data: processed, name: file.name, type: 'image/jpeg', isPdf: false, timestamp: new Date().toISOString() });
                                renderDelpechPhotos(); validateDelpechForm();
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            });

            // Validation sur saisie
            ['delpechEnvoyeurInput', 'delpechClientInput', 'delpechPromisInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', validateDelpechForm);
            });

            // Submit
            document.getElementById('btnDelpechSubmit').addEventListener('click', submitDelpech);
        }

        function renderDelpechPhotos() {
            document.getElementById('delpechPhotosGrid').innerHTML = delpechState.photos.map((p, i) => {
                if (p.isPdf) {
                    return `<div class="photo-thumb photo-thumb-pdf">
                        <div class="pdf-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor" font-weight="bold">PDF</text>
                        </svg></div>
                        <span class="photo-thumb-badge">${i + 1}</span>
                        <button class="photo-thumb-remove" onclick="removeDelpechPhoto(${i})">√ó</button>
                    </div>`;
                } else {
                    return `<div class="photo-thumb">
                        <img src="${p.data}" alt="Pr√©pa ${i + 1}">
                        <span class="photo-thumb-badge">${i + 1}</span>
                        <button class="photo-thumb-remove" onclick="removeDelpechPhoto(${i})">√ó</button>
                    </div>`;
                }
            }).join('');
        }

        function removeDelpechPhoto(i) {
            delpechState.photos.splice(i, 1);
            renderDelpechPhotos();
            validateDelpechForm();
        }

        function selectFacturation(type) {
            delpechState.facturation = type;
            document.getElementById('btnPaye').className = 'facturation-btn' + (type === 'paye' ? ' active-paye' : '');
            document.getElementById('btnNonFacture').className = 'facturation-btn' + (type === 'nonfacture' ? ' active-nonfacture' : '');
        }

        function validateDelpechForm() {
            const ok = document.getElementById('delpechEnvoyeurInput').value.trim()
                    && document.getElementById('delpechClientInput').value.trim()
                    && document.getElementById('delpechPromisInput').value.trim()
                    && delpechState.photos.length > 0;
            document.getElementById('btnDelpechSubmit').disabled = !ok;
        }

        async function submitDelpech() {
            const btn = document.getElementById('btnDelpechSubmit');
            const url = getVal('mlp_delpech_webhook_url');
            if (!url) { showToast('Configurez le webhook Delpech dans R√©glages', 'error'); return; }

            btn.classList.add('loading');
            btn.disabled = true;

            const envoyeur  = document.getElementById('delpechEnvoyeurInput').value.trim();
            const client    = document.getElementById('delpechClientInput').value.trim();
            const principe  = document.getElementById('delpechPrincipeInput').value.trim();
            const promis    = document.getElementById('delpechPromisInput').value.trim();
            const now       = new Date();
            const dateISO   = now.toISOString();
            const dd      = String(now.getDate()).padStart(2,'0');
            const mm      = String(now.getMonth()+1).padStart(2,'0');
            const yyyy    = now.getFullYear();
            const hh      = String(now.getHours()).padStart(2,'0');
            const min     = String(now.getMinutes()).padStart(2,'0');
            const dateStr = `${dd}-${mm}-${yyyy}_${hh}-${min}`;
            const clientSlug = client.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
            const promisSlug = promis.replace(/[^A-Za-z0-9]/g, '_');

            const payload = {
                type:        'DELPECH',
                labo:        'DELPECH PREPARATOIRE',
                envoyeur,
                client,
                principe,
                promis,
                facturation: delpechState.facturation,
                date:        dateISO,
                emailDest:   'commandespharmacienast@gmail.com',
                photos: delpechState.photos.map((p, i) => {
                    const [header, base64] = p.data.split(',');
                    const mimeType = header.replace('data:', '').replace(';base64', '');
                    const ext = p.isPdf ? 'pdf' : mimeType.includes('png') ? 'png' : 'jpg';
                    // Nom : DELPECH_ENVOYEUR_CLIENT_PROMIS_15-02-2026_22-45_p1.jpg
                    const envoyeurSlug = envoyeur.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
                    const filename = `DELPECH_${envoyeurSlug}_CLIENT_${clientSlug}_${promisSlug}_${dateStr}_p${i + 1}.${ext}`;
                    return { index: i + 1, data: base64, mimeType, filename, isPdf: p.isPdf };
                })
            };

            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    // Reset formulaire
                    document.getElementById('delpechEnvoyeurInput').value = '';
                    document.getElementById('delpechClientInput').value = '';
                    document.getElementById('delpechPrincipeInput').value = '';
                    document.getElementById('delpechPromisInput').value = '';
                    delpechState.photos = [];
                    delpechState.facturation = 'paye';
                    selectFacturation('paye');
                    renderDelpechPhotos();
                    showToast(`Delpech ${client} envoy√© !`, 'success');
                } else {
                    showToast('Erreur ‚Äî v√©rifiez le webhook', 'error');
                }
            } catch (e) {
                showToast('Serveur n8n injoignable', 'error');
            }
            btn.classList.remove('loading');
            validateDelpechForm();
        }

        init();
    </script>
</body>
</html>
