<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Pharmacie Nast â€” Gestion</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Couleurs Pharmacie Nast â€” inspirÃ©es de mapharmacienast.com */
            --nast-pink: #E91E63;
            --nast-pink-dark: #C2185B;
            --nast-pink-light: #FCE4EC;
            --nast-turquoise: #26C6DA;
            --nast-turquoise-dark: #00ACC1;
            --nast-turquoise-light: #E0F7FA;
            --nast-blue: #2C4A5E;
            --nast-blue-light: #3a5068;
            --nast-glow: rgba(233, 30, 99, 0.08);
            --nast-glow-md: rgba(233, 30, 99, 0.12);
            --nast-glow-strong: rgba(233, 30, 99, 0.18);

            --bg-primary: #ffffff;
            --bg-secondary: #f7f9fb;
            --bg-card: #ffffff;
            --bg-input: #f2f5f8;

            --text-primary: #1a2332;
            --text-secondary: #5a6a7e;
            --text-muted: #9aa8b8;
            --text-on-primary: #ffffff;

            --danger: #e74c3c;
            --danger-bg: #fdf0ef;
            --warning: #f39c12;
            --success: #26C6DA;

            --border: #e8ecf0;
            --border-light: #f0f2f5;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);

            --radius: 14px;
            --radius-sm: 10px;
            --radius-xs: 8px;

            --font-body: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: var(--font-body);
            background: var(--bg-secondary);
            color: var(--text-primary);
            overscroll-behavior: none;
        }

        /* â”€â”€â”€ APP SHELL â”€â”€â”€ */
        .app {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg-primary);
            position: relative;
        }

        /* â”€â”€â”€ HEADER â”€â”€â”€ */
        .header {
            padding: 14px 20px 14px;
            background: linear-gradient(135deg, var(--nast-pink) 0%, var(--nast-turquoise) 100%);
            color: white;
            position: relative;
            z-index: 10;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-cross {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-cross svg {
            width: 18px;
            height: 18px;
            color: var(--nast-pink);
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
            opacity: 0.95;
        }

        .header-date {
            font-size: 11px;
            opacity: 0.75;
            font-weight: 400;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-top: 4px;
        }

        /* â”€â”€â”€ CONTENT â”€â”€â”€ */
        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: calc(90px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
            background: var(--bg-secondary);
        }

        /* â”€â”€â”€ TAB BAR â”€â”€â”€ */
        .tab-bar {
            display: flex;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            padding: 4px 4px calc(4px + var(--safe-bottom));
            position: relative;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 5px 2px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            letter-spacing: -0.2px;
        }

        .tab-item.active {
            color: var(--nast-pink);
        }

        .tab-item.active .tab-icon-wrap {
            background: var(--nast-pink-light);
        }

        .tab-icon-wrap {
            width: 36px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .tab-icon {
            width: 18px;
            height: 18px;
        }

        /* â”€â”€â”€ CARDS â”€â”€â”€ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--nast-pink);
        }

        /* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€ */
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1.5px solid transparent;
            border-radius: var(--radius-xs);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .input:focus {
            border-color: var(--nast-pink);
            background: white;
            box-shadow: 0 0 0 3px var(--nast-glow-md);
        }

        .input::placeholder { color: var(--text-muted); }

        textarea.input {
            resize: vertical;
            min-height: 100px;
        }

        /* Labo selector */
        .labo-selector { position: relative; }

        .labo-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-xs);
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .labo-suggestions.show { display: block; }

        .labo-suggestion {
            padding: 11px 14px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s;
        }

        .labo-suggestion:last-child { border-bottom: none; }

        .labo-suggestion:hover, .labo-suggestion:active {
            background: var(--nast-pink-light);
        }

        .labo-suggestion mark {
            background: none;
            color: var(--nast-pink);
            font-weight: 600;
        }

        /* Photo zone */
        .photo-zone {
            border: 2px dashed var(--nast-pink);
            border-radius: var(--radius);
            padding: 28px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--nast-glow);
        }

        .photo-zone:active {
            transform: scale(0.98);
            background: var(--nast-glow-strong);
        }

        .photo-zone-icon {
            width: 42px;
            height: 42px;
            margin: 0 auto 10px;
            color: var(--nast-pink);
        }

        .photo-zone-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--nast-pink-dark);
        }

        .photo-zone-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        #photoInput { display: none; }

        /* Photo grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .photo-thumb {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: var(--radius-xs);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-thumb-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--nast-pink);
            color: white;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 500;
            padding: 2px 7px;
            border-radius: 6px;
        }

        .photo-thumb-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .photo-thumb-pdf {
            background: var(--nast-pink-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-icon {
            width: 50%;
            height: 50%;
            color: var(--nast-pink);
        }

        .pdf-icon svg {
            width: 100%;
            height: 100%;
        }

        /* Site selector */
        .site-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
        }

        .site-btn {
            flex: 1;
            padding: 10px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .site-btn.active {
            border-color: var(--nast-pink);
            background: var(--nast-pink-light);
            color: var(--nast-pink-dark);
            font-weight: 600;
        }

        /* Submit button */
        .btn-submit {
            width: 100%;
            padding: 14px;
            background: var(--nast-pink);
            color: white;
            border: none;
            border-radius: var(--radius-xs);
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 166, 81, 0.25);
            margin-top: 6px;
        }

        .btn-submit:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-submit:not(:disabled):active {
            transform: scale(0.98);
            background: var(--nast-pink-dark);
        }

        .btn-submit.loading { color: transparent; }

        .btn-submit.loading::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border: 3px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            top: 50%;
            left: 50%;
            margin: -11px 0 0 -11px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            background: white;
            border: 1px solid var(--nast-pink);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius-xs);
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90vw;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }

        .toast-icon { font-size: 16px; }
        .toast.success .toast-icon { color: var(--nast-pink); }
        .toast.error { border-color: var(--danger); }
        .toast.error .toast-icon { color: var(--danger); }

        /* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
        .stat-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .stat-card-value {
            font-family: var(--font-mono);
            font-size: 32px;
            font-weight: 700;
            color: var(--nast-pink);
            line-height: 1;
        }

        .stat-card-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 500;
        }

        .recent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            box-shadow: var(--shadow-sm);
        }

        .recent-item-icon {
            width: 36px;
            height: 36px;
            background: var(--nast-pink-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--nast-pink);
            flex-shrink: 0;
        }

        .recent-item-info { flex: 1; min-width: 0; }

        .recent-item-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 40px; margin-bottom: 8px; opacity: 0.4; }

        /* â”€â”€â”€ SETTINGS â”€â”€â”€ */
        .settings-group {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
        }

        .settings-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:last-child { border-bottom: none; }

        .settings-item-label {
            font-size: 14px;
            font-weight: 500;
        }

        .webhook-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .webhook-status.connected {
            background: var(--nast-pink-light);
            color: var(--nast-pink-dark);
        }

        .webhook-status.disconnected {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .webhook-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .settings-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1.5px solid transparent;
            border-radius: var(--radius-xs);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .settings-input:focus {
            border-color: var(--nast-pink);
            background: white;
        }

        .btn-save {
            padding: 10px 20px;
            background: var(--nast-pink);
            color: white;
            border: none;
            border-radius: var(--radius-xs);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn-save:active { background: var(--nast-pink-dark); }

        /* Tab content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* â”€â”€â”€ DELPECH â€” case Ã  cocher facturation â”€â”€â”€ */
        .facturation-toggle {
            display: flex;
            gap: 8px;
        }

        .facturation-btn {
            flex: 1;
            padding: 11px 8px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .facturation-btn.active-paye {
            border-color: #26C6DA;
            background: var(--nast-turquoise-light);
            color: var(--nast-turquoise-dark);
            font-weight: 600;
        }

        .facturation-btn.active-nonfacture {
            border-color: var(--warning);
            background: #fff8e1;
            color: #e65100;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-cross">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                    </div>
                    <span class="logo-text">Pharmacie Nast</span>
                </div>
                <span class="header-date" id="headerDate"></span>
            </div>
            <h1 id="headerTitle">RÃ©ception BL</h1>
        </header>

        <!-- Content -->
        <main class="content">

            <!-- TAB: RÃ©ception BL -->
            <div class="tab-content active" id="tabReception">
                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Informations livraison</div>

                    <div class="form-group">
                        <label class="form-label">Laboratoire</label>
                        <div class="labo-selector">
                            <input type="text" class="input" id="laboInput" placeholder="Rechercher ou saisir un labo..." autocomplete="off">
                            <div class="labo-suggestions" id="laboSuggestions"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">RÃ©ceptionnÃ© par</label>
                        <input type="text" class="input" id="receptInput" placeholder="Nom du rÃ©ceptionnaire">
                    </div>


                </div>

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Photos du bon de livraison</div>
                    <div class="photo-zone" id="photoZone">
                        <svg class="photo-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <div class="photo-zone-text">Ajouter le bon de livraison</div>
                        <div class="photo-zone-sub">Photo, PDF ou image Â· Plusieurs fichiers possibles</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*,application/pdf" multiple>
                    <div class="photos-grid" id="photosGrid"></div>
                </div>

                <button class="btn-submit" id="btnSubmit" disabled>
                    âœ“ Envoyer sur Google Drive
                </button>
            </div>

            <!-- TAB: Dashboard -->
            <div class="tab-content" id="tabDashboard">
                <div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>Aujourd'hui</div>
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="statToday">0</div>
                        <div class="stat-card-label">RÃ©ceptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="statLabos">0</div>
                        <div class="stat-card-label">Labos diffÃ©rents</div>
                    </div>
                </div>

                <div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>DerniÃ¨res rÃ©ceptions</div>
                <div class="recent-list" id="recentList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¦</div>
                        <p>Aucune rÃ©ception enregistrÃ©e</p>
                    </div>
                </div>
            </div>

            <!-- TAB: ParamÃ¨tres -->
            <div class="tab-content" id="tabSettings">
                <div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>Webhooks n8n</div>
                <div class="settings-group">
                    <div class="settings-item">
                        <span class="settings-item-label">Statut BL</span>
                        <span class="webhook-status disconnected" id="webhookStatus">
                            <span class="webhook-dot"></span>
                            Non configurÃ©
                        </span>
                    </div>
                    <div style="padding: 14px 16px;">
                        <label class="form-label">URL webhook â€” RÃ©ception BL</label>
                        <input type="url" class="settings-input" id="webhookUrlInput" placeholder="https://n8n.example.com/webhook/reception-bl">
                        <button class="btn-save" id="btnSaveSettings">Sauvegarder</button>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-item">
                        <span class="settings-item-label">Statut Delpech</span>
                        <span class="webhook-status disconnected" id="webhookDelpechStatus">
                            <span class="webhook-dot"></span>
                            Non configurÃ©
                        </span>
                    </div>
                    <div style="padding: 14px 16px;">
                        <label class="form-label">URL webhook â€” Delpech PrÃ©paratoire</label>
                        <input type="url" class="settings-input" id="webhookDelpechInput" placeholder="https://n8n.example.com/webhook/delpech">
                        <button class="btn-save" id="btnSaveDelpechWebhook">Sauvegarder</button>
                    </div>
                </div>

                <div class="card-title" style="margin-bottom:10px;"><span class="card-title-dot"></span>Liste des laboratoires</div>
                <div class="settings-group">
                    <div style="padding: 14px 16px;">
                        <label class="form-label">Un labo par ligne</label>
                        <textarea class="input" id="labosListInput" style="min-height:180px;font-size:13px;" placeholder="BIOGARAN&#10;SANDOZ&#10;MYLAN&#10;..."></textarea>
                        <button class="btn-save" id="btnSaveLabos">Sauvegarder les labos</button>
                    </div>
                </div>
            </div>

            <!-- TAB: Delpech PrÃ©paratoire -->
            <div class="tab-content" id="tabDelpech">
                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>PrÃ©paration magistrale</div>

                    <div class="form-group">
                        <label class="form-label">Laboratoire</label>
                        <input type="text" class="input" id="delpechLaboInput" value="DELPECH PREPARATOIRE" readonly style="color:var(--text-muted);background:var(--bg-input);">
                    </div>

                    <div class="form-group">
                        <label class="form-label">EnvoyÃ© par</label>
                        <input type="text" class="input" id="delpechEnvoyeurInput" placeholder="Nom de l'expÃ©diteur">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nom du client</label>
                        <input type="text" class="input" id="delpechClientInput" placeholder="Nom / PrÃ©nom du patient">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Principe actif de la prÃ©paration</label>
                        <input type="text" class="input" id="delpechPrincipeInput" placeholder="ex: KÃ©toprofÃ¨ne 2,5%">
                    </div>

                    <div class="form-group">
                        <label class="form-label">NumÃ©ro du promis</label>
                        <input type="text" class="input" id="delpechPromisInput" placeholder="NÂ° promis">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Statut facturation</label>
                        <div class="facturation-toggle">
                            <button class="facturation-btn active-paye" id="btnPaye" onclick="selectFacturation('paye')">âœ“ PayÃ© / FacturÃ©</button>
                            <button class="facturation-btn" id="btnNonFacture" onclick="selectFacturation('nonfacture')">âš  Non facturÃ©</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="card-title-dot"></span>Photo / document de la prÃ©paration</div>
                    <div class="photo-zone" id="delpechPhotoZone">
                        <svg class="photo-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <div class="photo-zone-text">Ajouter la prÃ©paration</div>
                        <div class="photo-zone-sub">Photo ou PDF Â· Plusieurs fichiers possibles</div>
                    </div>
                    <input type="file" id="delpechPhotoInput" accept="image/*,application/pdf" multiple>
                    <div class="photos-grid" id="delpechPhotosGrid"></div>
                </div>

                <button class="btn-submit" id="btnDelpechSubmit" disabled>
                    âœ‰ Envoyer par mail + Drive
                </button>
            </div>

        </main>

        <!-- Tab Bar -->
        <nav class="tab-bar">
            <button class="tab-item active" data-tab="tabReception" data-title="RÃ©ception BL">
                <div class="tab-icon-wrap">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </div>
                RECEPTION/BL
            </button>
            <button class="tab-item" data-tab="tabDelpech" data-title="Delpech PrÃ©paratoire">
                <div class="tab-icon-wrap">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2v-4M9 21H5a2 2 0 0 1-2-2v-4m0 0h18"/>
                    </svg>
                </div>
                DELPECH
            </button>
            <button class="tab-item" data-tab="tabDashboard" data-title="Tableau de bord">
                <div class="tab-icon-wrap">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </div>
                Dashboard
            </button>
            <button class="tab-item" data-tab="tabSettings" data-title="ParamÃ¨tres">
                <div class="tab-icon-wrap">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </div>
                RÃ©glages
            </button>
        </nav>

        <!-- Toast -->
        <div class="toast" id="toast">
            <span class="toast-icon">âœ“</span>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // â”€â”€â”€ STATE â”€â”€â”€
        const state = { photos: [], recentReceptions: [], labos: [], site: 'NAST' };
        const delpechState = { photos: [], facturation: 'paye' };

        const DEFAULT_LABOS = [
            'ABBOTT', 'ACCU-CHECK', 'ARROW', 'BAUSCH & LOMB', 'BAYER', 'BIOGARAN',
            'BIODERMA', 'BOIRON', 'BRAUN', 'COOPER', 'EAFIT', 'EG LABO', 'ELANCO',
            'FORTÃ‰ PHARMA', 'GALLIA', 'GSK', 'JOHNSON & JOHNSON', 'LA ROCHE-POSAY',
            'LEO PHARMA', 'LES SECRETS DE LOLY', 'LUXÃ‰OL', 'MERCK', 'MY VARIATIONS',
            'MYLAN', 'NOVARTIS', 'NUTRI&CO', 'NUXE', 'OENOBIOL', 'ONE TOUCH',
            'PFIZER', 'PIERRE FABRE', 'PURESSENTIEL', 'ROC', 'ROCHE', 'SANOFI',
            'SANDOZ', 'SERVIER', 'SUPERDIET', 'SVR', 'TENA', 'TEVA', 'THÃ‰RALICA',
            'TOPICREM', 'URIAGE', 'URGO', 'VIATRIS', 'VICHY'
        ];

        // â”€â”€â”€ INIT â”€â”€â”€
        function init() {
            updateDate();
            loadSettings();
            loadLabos();
            loadHistory();
            setupTabs();
            setupLaboInput();
            setupPhotoCapture();
            setupFormValidation();
            setupSettings();
            setupDelpech();
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('headerDate').textContent = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        // â”€â”€â”€ TABS â”€â”€â”€
        function setupTabs() {
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    document.getElementById('headerTitle').textContent = tab.dataset.title;
                });
            });
        }

        // â”€â”€â”€ SITE SELECTOR â”€â”€â”€
        function selectSite(btn) {
            document.querySelectorAll('.site-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.site = btn.dataset.site;
        }

        // â”€â”€â”€ LABO â”€â”€â”€
        function setupLaboInput() {
            const input = document.getElementById('laboInput');
            const suggestions = document.getElementById('laboSuggestions');

            input.addEventListener('input', () => {
                const val = input.value.trim().toUpperCase();
                if (!val) { suggestions.classList.remove('show'); validateForm(); return; }
                const matches = state.labos.filter(l => l.toUpperCase().includes(val));
                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(m => {
                        const hl = m.replace(new RegExp(`(${val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<mark>$1</mark>');
                        return `<div class="labo-suggestion">${hl}</div>`;
                    }).join('');
                    suggestions.classList.add('show');
                    suggestions.querySelectorAll('.labo-suggestion').forEach(s => {
                        s.addEventListener('click', () => {
                            input.value = s.textContent;
                            suggestions.classList.remove('show');
                            validateForm();
                        });
                    });
                } else {
                    suggestions.classList.remove('show');
                }
                validateForm();
            });

            input.addEventListener('focus', () => { if (input.value.trim()) input.dispatchEvent(new Event('input')); });
            document.addEventListener('click', (e) => { if (!e.target.closest('.labo-selector')) suggestions.classList.remove('show'); });
        }

        // â”€â”€â”€ PHOTOS â”€â”€â”€
        function setupPhotoCapture() {
            const zone = document.getElementById('photoZone');
            const input = document.getElementById('photoInput');
            zone.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const isPdf = file.type === 'application/pdf';
                        state.photos.push({ 
                            data: ev.target.result, 
                            name: file.name, 
                            type: file.type,
                            isPdf: isPdf,
                            timestamp: new Date().toISOString() 
                        });
                        renderPhotos();
                        validateForm();
                    };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            });
        }

        function renderPhotos() {
            document.getElementById('photosGrid').innerHTML = state.photos.map((p, i) => {
                if (p.isPdf) {
                    return `
                        <div class="photo-thumb photo-thumb-pdf">
                            <div class="pdf-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor" font-weight="bold">PDF</text>
                                </svg>
                            </div>
                            <span class="photo-thumb-badge">${i + 1}</span>
                            <button class="photo-thumb-remove" onclick="removePhoto(${i})">Ã—</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="photo-thumb">
                            <img src="${p.data}" alt="BL page ${i + 1}">
                            <span class="photo-thumb-badge">${i + 1}</span>
                            <button class="photo-thumb-remove" onclick="removePhoto(${i})">Ã—</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removePhoto(i) { state.photos.splice(i, 1); renderPhotos(); validateForm(); }



        // â”€â”€â”€ VALIDATION â”€â”€â”€
        function setupFormValidation() {
            ['laboInput', 'receptInput'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));
            document.getElementById('btnSubmit').addEventListener('click', submitReception);
        }

        function validateForm() {
            const ok = document.getElementById('laboInput').value.trim() && document.getElementById('receptInput').value.trim() && state.photos.length > 0;
            document.getElementById('btnSubmit').disabled = !ok;
        }



        // â”€â”€â”€ SUBMIT RECEPTION â”€â”€â”€
        async function submitReception() {
            const btn = document.getElementById('btnSubmit');
            const url = getVal('mlp_webhook_url');
            if (!url) { showToast('Configurez le webhook dans RÃ©glages', 'error'); return; }

            btn.classList.add('loading');
            btn.disabled = true;

            const labo     = document.getElementById('laboInput').value.trim().toUpperCase();
            const receptionnaire = document.getElementById('receptInput').value.trim();
            const now      = new Date();
            const dateISO  = now.toISOString();
            // Format date pour le nom de fichier : JJ-MM-AAAA_HH-MM
            const dd      = String(now.getDate()).padStart(2,'0');
            const mm      = String(now.getMonth()+1).padStart(2,'0');
            const yyyy    = now.getFullYear();
            const hh      = String(now.getHours()).padStart(2,'0');
            const min     = String(now.getMinutes()).padStart(2,'0');
            const dateStr = `${dd}-${mm}-${yyyy}_${hh}-${min}`;

            const laboSlug = labo.replace(/[^A-Z0-9]/g, '_');

            const payload = {
                labo,
                receptionnaire,
                date: dateISO,
                site: state.site,
                photos: state.photos.map((p, i) => {
                    const [header, base64] = p.data.split(',');
                    const mimeType = header.replace('data:', '').replace(';base64', '');

                    const ext = p.isPdf ? 'pdf'
                              : mimeType.includes('png') ? 'png'
                              : mimeType.includes('webp') ? 'webp'
                              : 'jpg';

                    // Nom de fichier : BL_BIOGARAN_XAVIER_15-02-2026_22-45_p1.jpg
                    const receptSlug = receptionnaire.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
                    const filename = `BL_${laboSlug}_${receptSlug}_${dateStr}_p${i + 1}.${ext}`;

                    return {
                        index:    i + 1,
                        data:     base64,
                        mimeType: mimeType,
                        filename: filename,
                        isPdf:    p.isPdf
                    };
                })
            };

            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    addToHistory({ labo: payload.labo, receptionnaire: payload.receptionnaire, date: payload.date, photoCount: state.photos.length, site: state.site });
                    document.getElementById('laboInput').value = '';
                    document.getElementById('receptInput').value = '';
                    state.photos = [];
                    renderPhotos();
                    showToast(`BL ${payload.labo} envoyÃ© sur Drive !`, 'success');
                } else {
                    showToast('Erreur â€” vÃ©rifiez le webhook', 'error');
                }
            } catch (e) {
                showToast('Serveur n8n injoignable', 'error');
            }
            btn.classList.remove('loading');
            validateForm();
        }



        // â”€â”€â”€ HISTORY â”€â”€â”€
        function addToHistory(entry) {
            state.recentReceptions.unshift(entry);
            if (state.recentReceptions.length > 50) state.recentReceptions.pop();
            setVal('mlp_history', JSON.stringify(state.recentReceptions));
            renderDashboard();
        }

        function loadHistory() {
            try { const s = getVal('mlp_history'); if (s) state.recentReceptions = JSON.parse(s); } catch (e) {}
            renderDashboard();
        }

        function renderDashboard() {
            const today = new Date().toISOString().slice(0, 10);
            const todayEntries = state.recentReceptions.filter(r => r.date?.startsWith(today));
            document.getElementById('statToday').textContent = todayEntries.length;
            document.getElementById('statLabos').textContent = new Set(todayEntries.map(r => r.labo)).size;

            const list = document.getElementById('recentList');
            if (!state.recentReceptions.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“¦</div><p>Aucune rÃ©ception enregistrÃ©e</p></div>';
                return;
            }
            list.innerHTML = state.recentReceptions.slice(0, 20).map(r => {
                const d = new Date(r.date);
                return `<div class="recent-item">
                    <div class="recent-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div>
                    <div class="recent-item-info">
                        <div class="recent-item-title">${r.labo}</div>
                        <div class="recent-item-meta">${r.receptionnaire} Â· ${r.photoCount} page(s) Â· ${r.site || 'NAST'} Â· ${d.toLocaleDateString('fr-FR', {day:'numeric',month:'short'})} ${d.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function loadLabos() {
            try { const s = getVal('mlp_labos'); state.labos = s ? JSON.parse(s) : DEFAULT_LABOS; } catch (e) { state.labos = DEFAULT_LABOS; }
            document.getElementById('labosListInput').value = state.labos.join('\n');
        }

        // â”€â”€â”€ STORAGE HELPERS â”€â”€â”€
        function getVal(k) { try { return localStorage.getItem(k) || ''; } catch (e) { return ''; } }
        function setVal(k, v) { try { localStorage.setItem(k, v); } catch (e) {} }

        // â”€â”€â”€ TOAST â”€â”€â”€
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            toast.querySelector('.toast-icon').textContent = type === 'error' ? 'âœ•' : 'âœ“';
            toast.className = `toast ${type}`;
            requestAnimationFrame(() => { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); });
        }

        // â”€â”€â”€ SETTINGS Delpech â”€â”€â”€
        function setupSettings() {
            document.getElementById('btnSaveSettings').addEventListener('click', () => {
                setVal('mlp_webhook_url', document.getElementById('webhookUrlInput').value.trim());
                updateWebhookStatus();
                showToast('ParamÃ¨tres sauvegardÃ©s', 'success');
            });
            document.getElementById('btnSaveDelpechWebhook').addEventListener('click', () => {
                setVal('mlp_delpech_webhook_url', document.getElementById('webhookDelpechInput').value.trim());
                updateDelpechWebhookStatus();
                showToast('Webhook Delpech sauvegardÃ©', 'success');
            });
            document.getElementById('btnSaveLabos').addEventListener('click', () => {
                state.labos = document.getElementById('labosListInput').value.split('\n').map(l => l.trim()).filter(Boolean).sort();
                setVal('mlp_labos', JSON.stringify(state.labos));
                document.getElementById('labosListInput').value = state.labos.join('\n');
                showToast(`${state.labos.length} labos sauvegardÃ©s`, 'success');
            });
        }

        function loadSettings() {
            const blUrl = getVal('mlp_webhook_url') || 'https://n8n.srv1086994.hstgr.cloud/webhook/reception-bl';
            const delpechUrl = getVal('mlp_delpech_webhook_url') || 'https://n8n.srv1086994.hstgr.cloud/webhook/delpech-preparatoire';
            if (!getVal('mlp_webhook_url')) setVal('mlp_webhook_url', blUrl);
            if (!getVal('mlp_delpech_webhook_url')) setVal('mlp_delpech_webhook_url', delpechUrl);
            document.getElementById('webhookUrlInput').value = blUrl;
            document.getElementById('webhookDelpechInput').value = delpechUrl;
            updateWebhookStatus();
            updateDelpechWebhookStatus();
        }

        function updateWebhookStatus() {
            const s = document.getElementById('webhookStatus');
            if (getVal('mlp_webhook_url')) {
                s.className = 'webhook-status connected';
                s.innerHTML = '<span class="webhook-dot"></span>ConnectÃ©';
            } else {
                s.className = 'webhook-status disconnected';
                s.innerHTML = '<span class="webhook-dot"></span>Non configurÃ©';
            }
        }

        function updateDelpechWebhookStatus() {
            const s = document.getElementById('webhookDelpechStatus');
            if (getVal('mlp_delpech_webhook_url')) {
                s.className = 'webhook-status connected';
                s.innerHTML = '<span class="webhook-dot"></span>ConnectÃ©';
            } else {
                s.className = 'webhook-status disconnected';
                s.innerHTML = '<span class="webhook-dot"></span>Non configurÃ©';
            }
        }

        // â”€â”€â”€ DELPECH SETUP â”€â”€â”€
        function setupDelpech() {
            // Photos
            const zone = document.getElementById('delpechPhotoZone');
            const input = document.getElementById('delpechPhotoInput');
            zone.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        delpechState.photos.push({
                            data: ev.target.result,
                            name: file.name,
                            type: file.type,
                            isPdf: file.type === 'application/pdf',
                            timestamp: new Date().toISOString()
                        });
                        renderDelpechPhotos();
                        validateDelpechForm();
                    };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            });

            // Validation sur saisie
            ['delpechEnvoyeurInput', 'delpechClientInput', 'delpechPromisInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', validateDelpechForm);
            });

            // Submit
            document.getElementById('btnDelpechSubmit').addEventListener('click', submitDelpech);
        }

        function renderDelpechPhotos() {
            document.getElementById('delpechPhotosGrid').innerHTML = delpechState.photos.map((p, i) => {
                if (p.isPdf) {
                    return `<div class="photo-thumb photo-thumb-pdf">
                        <div class="pdf-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor" font-weight="bold">PDF</text>
                        </svg></div>
                        <span class="photo-thumb-badge">${i + 1}</span>
                        <button class="photo-thumb-remove" onclick="removeDelpechPhoto(${i})">Ã—</button>
                    </div>`;
                } else {
                    return `<div class="photo-thumb">
                        <img src="${p.data}" alt="PrÃ©pa ${i + 1}">
                        <span class="photo-thumb-badge">${i + 1}</span>
                        <button class="photo-thumb-remove" onclick="removeDelpechPhoto(${i})">Ã—</button>
                    </div>`;
                }
            }).join('');
        }

        function removeDelpechPhoto(i) {
            delpechState.photos.splice(i, 1);
            renderDelpechPhotos();
            validateDelpechForm();
        }

        function selectFacturation(type) {
            delpechState.facturation = type;
            document.getElementById('btnPaye').className = 'facturation-btn' + (type === 'paye' ? ' active-paye' : '');
            document.getElementById('btnNonFacture').className = 'facturation-btn' + (type === 'nonfacture' ? ' active-nonfacture' : '');
        }

        function validateDelpechForm() {
            const ok = document.getElementById('delpechEnvoyeurInput').value.trim()
                    && document.getElementById('delpechClientInput').value.trim()
                    && document.getElementById('delpechPromisInput').value.trim()
                    && delpechState.photos.length > 0;
            document.getElementById('btnDelpechSubmit').disabled = !ok;
        }

        async function submitDelpech() {
            const btn = document.getElementById('btnDelpechSubmit');
            const url = getVal('mlp_delpech_webhook_url');
            if (!url) { showToast('Configurez le webhook Delpech dans RÃ©glages', 'error'); return; }

            btn.classList.add('loading');
            btn.disabled = true;

            const envoyeur  = document.getElementById('delpechEnvoyeurInput').value.trim();
            const client    = document.getElementById('delpechClientInput').value.trim();
            const principe  = document.getElementById('delpechPrincipeInput').value.trim();
            const promis    = document.getElementById('delpechPromisInput').value.trim();
            const now       = new Date();
            const dateISO   = now.toISOString();
            const dd      = String(now.getDate()).padStart(2,'0');
            const mm      = String(now.getMonth()+1).padStart(2,'0');
            const yyyy    = now.getFullYear();
            const hh      = String(now.getHours()).padStart(2,'0');
            const min     = String(now.getMinutes()).padStart(2,'0');
            const dateStr = `${dd}-${mm}-${yyyy}_${hh}-${min}`;
            const clientSlug = client.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
            const promisSlug = promis.replace(/[^A-Za-z0-9]/g, '_');

            const payload = {
                type:        'DELPECH',
                labo:        'DELPECH PREPARATOIRE',
                envoyeur,
                client,
                principe,
                promis,
                facturation: delpechState.facturation,
                date:        dateISO,
                emailDest:   'commandespharmacienast@gmail.com',
                photos: delpechState.photos.map((p, i) => {
                    const [header, base64] = p.data.split(',');
                    const mimeType = header.replace('data:', '').replace(';base64', '');
                    const ext = p.isPdf ? 'pdf' : mimeType.includes('png') ? 'png' : 'jpg';
                    // Nom : DELPECH_ENVOYEUR_CLIENT_PROMIS_15-02-2026_22-45_p1.jpg
                    const envoyeurSlug = envoyeur.replace(/[^A-Za-z0-9]/g, '_').toUpperCase();
                    const filename = `DELPECH_${envoyeurSlug}_CLIENT_${clientSlug}_${promisSlug}_${dateStr}_p${i + 1}.${ext}`;
                    return { index: i + 1, data: base64, mimeType, filename, isPdf: p.isPdf };
                })
            };

            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    // Reset formulaire
                    document.getElementById('delpechEnvoyeurInput').value = '';
                    document.getElementById('delpechClientInput').value = '';
                    document.getElementById('delpechPrincipeInput').value = '';
                    document.getElementById('delpechPromisInput').value = '';
                    delpechState.photos = [];
                    delpechState.facturation = 'paye';
                    selectFacturation('paye');
                    renderDelpechPhotos();
                    showToast(`Delpech ${client} envoyÃ© !`, 'success');
                } else {
                    showToast('Erreur â€” vÃ©rifiez le webhook', 'error');
                }
            } catch (e) {
                showToast('Serveur n8n injoignable', 'error');
            }
            btn.classList.remove('loading');
            validateDelpechForm();
        }

        init();
    </script>
</body>
</html>
